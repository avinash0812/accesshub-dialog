<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Request 2Actual Access — Task Module</title>
<style>
  :root{
    --brand:#0e5a73;           /* buttons/links */
    --brand-dark:#0b495d;
    --fg:#0f172a;
    --muted:#6b7280;
    --bg:#f8fafc;
    --card:#ffffff;
    --danger:#b91c1c;
    --ok:#065f46;
    --row-h:38px;              /* tighter rows */
    --radius:10px;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .shell{max-width:1100px;margin:24px auto;padding:0 16px;}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px;}
  .hdr{display:flex;align-items:center;gap:12px;margin:0 0 14px 0}
  .hdr h1{font-size:20px;margin:0}
  .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
  .btn{appearance:none;border:0;background:var(--brand);color:#fff;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#e5eef2;color:var(--brand);font-weight:700}
  .btn.ghost{background:#ffffff;border:1px solid #cbd5e1;color:var(--fg)}
  .btn.flat{background:transparent;color:var(--brand);padding:6px 10px}
  .btn:hover{background:var(--brand-dark)}
  .btn.secondary:hover{background:#d6e5ec}
  .btn.ghost:hover{background:#f1f5f9}
  .row{display:flex;gap:16px;align-items:center;margin:8px 0}
  .row > *{flex:1}
  label{font-weight:700}
  .req::after{content:" *"; color:var(--danger); font-weight:800}
  input[type="date"],input[type="text"],textarea,select{
    width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
  }
  textarea{min-height:110px; resize:vertical}
  .muted{color:var(--muted);font-size:12px}
  .err{color:var(--danger);font-weight:600;margin-top:6px}
  .ok{color:var(--ok);font-weight:700}
  .list{width:100%; border-collapse:collapse; background:#fff; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden}
  .list th, .list td{padding:6px 10px; border-bottom:1px solid #eef2f7}
  .list tr{height:var(--row-h)}
  .list th{background:#f1f5f9;text-align:left;font-size:14px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#eef6fb;border:1px solid #cfe3ee;color:#083344;padding:4px 10px;border-radius:999px;margin:4px 6px 0 0}
  .x{font-weight:900;cursor:pointer}
  .section-title{margin:10px 0 6px;font-size:18px;border-top:3px solid #5b9bd5;padding-top:10px}
  .space{height:6px}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .panel{background:#fff;width:min(680px,96vw);border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal .head{padding:12px 16px;border-bottom:1px solid #eef2f7;font-weight:700}
  .modal .body{padding:16px}
  .modal .foot{padding:14px 16px;border-top:1px solid #eef2f7;display:flex;gap:10px;justify-content:flex-end}
  .center-actions{display:flex;gap:10px}
</style>
</head>
<body>
<div class="shell">
  <div class="bar">
    <div class="center-actions">
      <button class="btn ghost" id="btnBack">&larr; Back</button>
      <button class="btn flat" id="btnClose">Close</button>
    </div>
    <strong>Request Actual Access</strong>
  </div>

  <!-- STEP 1: PRE-REQ -->
  <section class="card" id="step1">
    <div class="hdr"><h1>Pre-Requisites</h1></div>
    <div class="muted">Ensuring privacy … (static copy for POC)</div>
    <div class="space"></div>
    <div class="row">
      <div style="flex:0 0 180px;"><label class="req">Agreement</label></div>
      <div><span id="agreementState" class="ok">Agreement signed.</span></div>
      <div style="flex:0 0 200px;text-align:right">
        <button class="btn secondary" id="markAgreement">Mark completed</button>
      </div>
    </div>
    <div class="row">
      <div style="flex:0 0 180px;"><label class="req">Training</label></div>
      <div><span id="trainingState" class="ok">Training Completed</span></div>
      <div style="flex:0 0 200px;text-align:right">
        <button class="btn secondary" id="markTraining">Mark completed</button>
      </div>
    </div>
    <div id="step1Err" class="err" style="display:none"></div>
    <div class="space"></div>
    <div style="text-align:right">
      <button class="btn" id="toStep2" disabled>Next</button>
    </div>
  </section>

  <!-- STEP 2: USERS + DURATION -->
  <section class="card" id="step2" style="display:none">
    <div class="hdr"><h1>Access Details</h1></div>

    <div class="row">
      <div>
        <label>Description</label>
        <input type="text" value="asdasdasdas." aria-label="desc" />
      </div>
    </div>

    <div class="row">
      <div>
        <label class="req">Enter user name</label>
        <input type="text" id="searchBox" placeholder="Search" />
      </div>
      <div style="flex:0 0 120px;align-self:flex-end;text-align:right">
        <button class="btn secondary" id="btnClear">Clear</button>
      </div>
    </div>

    <div>
      <div class="muted">Selected users</div>
      <div id="chips"></div>
    </div>

    <div class="section-title">Access Duration</div>
    <div class="row" style="align-items:flex-start">
      <div style="max-width:320px">
        <label class="req">Enter Duration</label>
        <input type="date" id="dt" />
        <div id="dtErr" class="err" style="display:none"></div>
        <div class="muted" id="dtNote">
          The date can not be today, before today or later than the current fiscal year (Fiscal year is – July 25 to Jun 26).
        </div>
      </div>
      <div style="flex:1"></div>
      <div style="flex:0 0 180px;align-self:flex-end;text-align:right">
        <button class="btn" id="nextFromStep2" disabled>Next</button>
      </div>
    </div>

    <div class="space"></div>
    <table class="list" id="tbl">
      <thead><tr><th style="width:40%">Alias</th><th style="width:40%">Display name</th><th style="width:20%"></th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <!-- STEP 3: TITLE + JUSTIFICATION -->
  <section class="card" id="step3" style="display:none">
    <div class="hdr"><h1>Title & Business Justification</h1></div>

    <div class="row" style="align-items:flex-end">
      <div>
        <label>Current title</label>
        <div class="pill" title="from HR system">Soft-Architect-Service</div>
      </div>
      <div></div>
      <div style="max-width:420px">
        <label>Your new title</label>
        <select id="newTitle">
          <option>Architect</option>
          <option>Senior Architect</option>
          <option>Principal Engineer</option>
          <option>Staff Engineer</option>
        </select>
      </div>
    </div>

    <div class="row" style="align-items:flex-start">
      <div style="max-width:640px">
        <label class="req">Business Justification</label>
        <textarea id="bz"></textarea>
        <div id="bzErr" class="err" style="display:none">Business justification is required.</div>
      </div>
      <div style="flex:1"></div>
      <div style="flex:0 0 180px;align-self:flex-end;text-align:right">
        <button class="btn" id="btnSubmit">Submit</button>
      </div>
    </div>
  </section>
</div>

<!-- CONFIRMATION (centered) -->
<div class="modal" id="confirm">
  <div class="panel">
    <div class="head">Confirm selection</div>
    <div class="body">
      <div id="confirmText"></div>
    </div>
    <div class="foot">
      <button class="btn ghost" id="cCancel">Cancel</button>
      <button class="btn" id="cOK">Confirm</button>
    </div>
  </div>
</div>

<!-- FEEDBACK (centered, compact) -->
<div class="modal" id="feedback">
  <div class="panel">
    <div class="head">Feedback</div>
    <div class="body">
      <div class="muted" style="margin-bottom:8px">Optional: share quick feedback about this flow.</div>
      <textarea id="fb" style="min-height:110px"></textarea>
    </div>
    <div class="foot">
      <button class="btn ghost" id="fbCancel">Cancel</button>
      <button class="btn" id="fbOK">OK</button>
    </div>
  </div>
</div>

<script>
/* =================== STATIC DATA (POC) =================== */
const allUsers = [
  { alias:"akanoo", name:"User Display" }, { alias:"alexr", name:"User Display" },
  { alias:"chenl",  name:"User Display" }, { alias:"dev_1", name:"User Display" },
  { alias:"isham",  name:"User Display" }, { alias:"jdoe",  name:"User Display" },
  { alias:"katew",  name:"User Display" }, { alias:"liamj", name:"User Display" },
  { alias:"mshah",  name:"User Display" }, { alias:"ninad", name:"User Display" },
  { alias:"olgap",  name:"User Display" }, { alias:"omarh", name:"User Display" },
  { alias:"pk",     name:"User Display" }, { alias:"ravin", name:"User Display" },
  { alias:"sarab",  name:"User Display" }, { alias:"timq",  name:"User Display" },
  { alias:"vikz",   name:"User Display" }, { alias:"zedx",  name:"User Display" }
].sort((a,b)=>a.alias.localeCompare(b.alias));

/* =================== DOM HOOKS =================== */
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const btnBack = document.getElementById('btnBack');
const btnClose = document.getElementById('btnClose');

const markAgreement = document.getElementById('markAgreement');
const markTraining = document.getElementById('markTraining');
const step1Err = document.getElementById('step1Err');
const toStep2 = document.getElementById('toStep2');

const rows = document.getElementById('rows');
const chips = document.getElementById('chips');
const searchBox = document.getElementById('searchBox');
const btnClear = document.getElementById('btnClear');
const nextFromStep2 = document.getElementById('nextFromStep2');
const dt = document.getElementById('dt');
const dtErr = document.getElementById('dtErr');

const newTitle = document.getElementById('newTitle');
const bz = document.getElementById('bz');
const bzErr = document.getElementById('bzErr');
const btnSubmit = document.getElementById('btnSubmit');

const confirm = document.getElementById('confirm');
const confirmText = document.getElementById('confirmText');
const cCancel = document.getElementById('cCancel');
const cOK = document.getElementById('cOK');

const feedback = document.getElementById('feedback');
const fb = document.getElementById('fb');
const fbCancel = document.getElementById('fbCancel');
const fbOK = document.getElementById('fbOK');

/* =================== NAV =================== */
let current = 1;
function show(step){
  step1.style.display = step===1?'block':'none';
  step2.style.display = step===2?'block':'none';
  step3.style.display = step===3?'block':'none';
  current = step;
}
btnBack.onclick = () => {
  if(current>1) show(current-1);
  else notifyParentClose();
};
btnClose.onclick = () => notifyParentClose();

/* Teams/Agent close (task module) */
function notifyParentClose(payload){
  try{ window.parent.postMessage({ type:"tm.close", payload }, "*"); }catch(e){}
}

/* =================== STEP 1: Pre-req =================== */
let prAgreement = true; // preset complete (demo)
let prTraining  = true;

function evalStep1(){
  step1Err.style.display = 'none';
  toStep2.disabled = !(prAgreement && prTraining);
}
markAgreement.onclick = ()=>{ prAgreement = true; evalStep1(); };
markTraining .onclick = ()=>{ prTraining  = true; evalStep1(); };
evalStep1();

toStep2.onclick = ()=> show(2);

/* =================== STEP 2: Users + Duration =================== */
let selected = new Set();

/* IST helpers & FY validation */
function nowIST(){
  const now = new Date();
  const istOffsetMin = 330; // +05:30
  return new Date(now.getTime() + (istOffsetMin - now.getTimezoneOffset())*60000);
}
function dateFromInputIST(str){
  return new Date(str + "T00:00:00+05:30");
}
function fyWindowFor(todayIST){
  const y = todayIST.getFullYear();
  const jul25This  = new Date(`${y}-07-25T00:00:00+05:30`);
  const jun26Next  = new Date(`${y+1}-06-26T23:59:59+05:30`);
  const jul25Prev  = new Date(`${y-1}-07-25T00:00:00+05:30`);
  const jun26This  = new Date(`${y}-06-26T23:59:59+05:30`);
  return (todayIST >= jul25This) ? {start: jul25This, end: jun26Next}
                                 : {start: jul25Prev, end: jun26This};
}
function validateDuration(){
  const val = dt.value;
  const today = nowIST();
  const {start,end} = fyWindowFor(today);
  let ok = false, msg="";
  if(!val){
    msg = "Please select a date.";
  }else{
    const chosen = dateFromInputIST(val);
    const isAfterToday = chosen > new Date(today.toDateString()); // strictly after today
    const inFY = (chosen>=start && chosen<=end);
    ok = isAfterToday && inFY;
    if(!ok){
      msg = "The date can not be today, before today or later than the current fiscal year (Fiscal year is – July 25 to Jun 26).";
    }
  }
  dtErr.textContent = msg;
  dtErr.style.display = ok ? "none" : "block";
  nextFromStep2.disabled = !(ok && selected.size>0);
  return ok;
}
/* preset date = today (IST) */
(function presetDateToToday(){
  const t = nowIST();
  const yyyy = t.getFullYear();
  const mm = String(t.getMonth()+1).padStart(2,'0');
  const dd = String(t.getDate()).padStart(2,'0');
  dt.value = `${yyyy}-${mm}-${dd}`;
  validateDuration();
})();
dt.addEventListener('change', validateDuration);

/* list rendering (alias sorted, add button disables when selected) */
function renderRows(){
  const q = searchBox.value.trim().toLowerCase();
  const frag = document.createDocumentFragment();
  allUsers.forEach(u=>{
    if(q && !(u.alias.toLowerCase().includes(q) || u.name.toLowerCase().includes(q))) return;
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = u.alias;
    const td2 = document.createElement('td'); td2.textContent = u.name;
    const td3 = document.createElement('td'); td3.style.textAlign='right';
    const b = document.createElement('button');
    b.className='btn'; b.textContent = selected.has(u.alias)?'Added':'Add';
    b.disabled = selected.has(u.alias);
    b.onclick = ()=>{ selected.add(u.alias); renderChips(); renderRows(); validateDuration(); };
    td3.appendChild(b);
    tr.append(td1,td2,td3);
    frag.appendChild(tr);
  });
  rows.replaceChildren(frag);
}
function renderChips(){
  const frag = document.createDocumentFragment();
  Array.from(selected).sort().forEach(a=>{
    const pill = document.createElement('span'); pill.className='pill';
    pill.innerHTML = `<span>${a}</span><span class="x" title="Remove">&times;</span>`;
    pill.querySelector('.x').onclick = ()=>{ selected.delete(a); renderChips(); renderRows(); validateDuration(); };
    frag.appendChild(pill);
  });
  chips.replaceChildren(frag);
}
renderRows();

searchBox.addEventListener('input', ()=> renderRows());
btnClear.onclick = ()=>{
  searchBox.value='';
  selected.clear();
  const t = nowIST();
  const yyyy = t.getFullYear(), mm=String(t.getMonth()+1).padStart(2,'0'), dd=String(t.getDate()).padStart(2,'0');
  dt.value = `${yyyy}-${mm}-${dd}`;
  renderChips(); renderRows(); validateDuration();
}

/* Next -> centered confirm */
nextFromStep2.onclick = ()=>{
  if(!validateDuration() || selected.size===0) return;
  const when = dt.value.split('-').reverse().join('/'); // dd/mm/yyyy
  const list = Array.from(selected).sort().map(a=>`<li>${a}</li>`).join('');
  confirmText.innerHTML = `<div>Following users are selected for <strong>${when}</strong>:</div><ul>${list}</ul>`;
  confirm.style.display='flex';
};
cCancel.onclick = ()=> confirm.style.display='none';
cOK.onclick = ()=>{ confirm.style.display='none'; show(3); };

/* =================== STEP 3: Title & BZ =================== */
function validateBZ(){
  const ok = bz.value.trim().length>0;
  bzErr.style.display = ok?'none':'block';
  return ok;
}
bz.addEventListener('input', validateBZ);

btnSubmit.onclick = ()=>{
  if(!validateBZ()) return;

  /* ----- PUSH: create request (Power Automate / API) -----
     const payload = {
       date: dt.value,
       users: Array.from(selected),
       newTitle: newTitle.value,
       justification: bz.value.trim()
     };
     fetch('<<YOUR_API_URL>>', {
       method:'POST', headers:{'content-type':'application/json'},
       body: JSON.stringify(payload)
     }).then(r=>r.json()).then(() => notifyParentClose({result:'ok', summary:payload}));
  --------------------------------------------------------- */

  // POC: show compact feedback; on OK close TM.
  feedback.style.display='flex';
};

/* FEEDBACK */
fbCancel.onclick = ()=>{ feedback.style.display='none'; notifyParentClose({result:'ok'}); };
fbOK.onclick = ()=>{
  /* ----- PUSH: store feedback (optional) -----
     fetch('<<FEEDBACK_API>>',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({text:fb.value})})
  ------------------------------------------------*/
  feedback.style.display='none';
  notifyParentClose({result:'ok', feedback: fb.value});
};

/* ----- PULL: preload data if needed -----
   Example:
   fetch('<<RETRIEVE_USERS_FOR_LOGIN_USER>>')
     .then(r=>r.json()).then(list => { ... });
------------------------------------------ */
</script>
</body>
</html>

