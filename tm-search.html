<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Request Actual Access — Search</title>

  <!-- Minimal styling via Bootstrap (ok for PoC) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Teams JS SDK (lets Submit/Close return data to the task module parent) -->
  <script src="https://res.cdn.office.net/teams-js/v2.15.0/js/MicrosoftTeams.min.js"></script>

  <style>
    body { background:#f8fafc; }
    .card { border-radius:14px; }
    .table thead th { font-weight:600; }
    .pill { display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef5ff; }
    .sticky-actions { position:sticky; bottom:0; background:#fff; padding:.75rem 1rem; border-top:1px solid #e9ecef; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="h4 fw-semibold mb-3">Request Actual Access — Search</h1>

    <div class="card shadow-sm">
      <div class="card-body">
        <form id="searchForm" class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Login user</label>
            <select id="loginUser" class="form-select">
              <option>User1</option>
              <option>User2</option>
              <option>User3</option>
              <option>User4</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Show</label>
            <select id="showCount" class="form-select">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
          </div>

          <div class="col-md-5">
            <label class="form-label">Search alias or name</label>
            <div class="input-group">
              <input id="query" class="form-control" placeholder="e.g. akanoo or Ashish" />
              <button id="btnSearch" class="btn btn-primary" type="submit">Search</button>
            </div>
          </div>

          <div class="col-md-2 d-flex gap-2 justify-content-end">
            <button id="btnCloseTop" class="btn btn-outline-secondary" type="button">Close</button>
            <button id="btnSubmitTop" class="btn btn-success" type="button">Submit</button>
          </div>
        </form>

        <hr class="my-3" />

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div><span id="resultCount" class="pill">0 results</span></div>
          <small class="text-muted">Tip: use the **Show** dropdown to cap results for the demo.</small>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle" id="resultTable">
            <thead>
              <tr>
                <th style="width:48px;"></th>
                <th>Alias</th>
                <th>Name</th>
              </tr>
            </thead>
            <tbody id="resultBody">
              <!-- rows inserted by JS -->
            </tbody>
          </table>
        </div>

        <div class="sticky-actions d-flex justify-content-between">
          <div class="text-muted small" id="selectionInfo">Nothing selected</div>
          <div class="d-flex gap-2">
            <button id="btnClose" class="btn btn-outline-secondary" type="button">Close</button>
            <button id="btnSubmit" class="btn btn-primary" type="button">Submit</button>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ---------- Demo dataset (static) ---------- */
const USERS = [
  { loginuser: "User1", alias: "akanoo", name: "Ashish Kanoongo" },
  { loginuser: "User1", alias: "jdoe",   name: "John Doe" },
  { loginuser: "User1", alias: "mshah",  name: "Meera Shah" },
  { loginuser: "User1", alias: "sgeorge",name: "Sam George" },
  { loginuser: "User1", alias: "pk",     name: "Priya K" },
  { loginuser: "User1", alias: "alexr",  name: "Alex R" },
  { loginuser: "User1", alias: "chenl",  name: "Chen Li" },

  { loginuser: "User2", alias: "katew",  name: "Kate W" },
  { loginuser: "User2", alias: "omarh",  name: "Omar H" },
  { loginuser: "User2", alias: "sarab",  name: "Sara B" },
  { loginuser: "User2", alias: "timq",   name: "Tim Q" },
  { loginuser: "User2", alias: "ninad",  name: "Nina D" },
  { loginuser: "User2", alias: "vikz",   name: "Vik Z" },

  { loginuser: "User3", alias: "liamj",  name: "Liam J" },
  { loginuser: "User3", alias: "isham",  name: "Isha M" },
  { loginuser: "User3", alias: "ravin",  name: "Ravi N" },
  { loginuser: "User3", alias: "olgap",  name: "Olga P" },

  { loginuser: "User4", alias: "zedx",   name: "Zed X" },
  { loginuser: "User4", alias: "riak",   name: "Riak" },
  { loginuser: "User4", alias: "dev_1",  name: "Dev One" }
];

/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function getQueryParams() {
  const p = new URLSearchParams(location.search);
  return {
    loginuser: p.get("loginuser") || "",
    show: parseInt(p.get("show") || "20", 10),
    q: p.get("q") || ""
  };
}

function filterUsers(loginUser, q, cap) {
  const lcq = q.trim().toLowerCase();
  let rows = USERS.filter(u => !loginUser || u.loginuser === loginUser);
  if (lcq) {
    rows = rows.filter(u =>
      u.alias.toLowerCase().includes(lcq) ||
      u.name.toLowerCase().includes(lcq)
    );
  }
  return rows.slice(0, cap);
}

function render(rows) {
  const body = $("#resultBody");
  body.innerHTML = "";
  rows.forEach((u, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-check-input row-check" type="checkbox" data-alias="${u.alias}" data-name="${u.name}"></td>
      <td><code>${u.alias}</code></td>
      <td>${u.name}</td>
    `;
    body.appendChild(tr);
  });
  $("#resultCount").textContent = `${rows.length} result${rows.length===1?"":"s"}`;
  updateSelectionInfo();
}

function getSelection() {
  const checks = $$(".row-check:checked");
  return checks.map(c => ({ alias: c.dataset.alias, name: c.dataset.name }));
}

function updateSelectionInfo() {
  const sel = getSelection();
  $("#selectionInfo").textContent = sel.length
    ? `Selected: ${sel.map(s => s.alias).join(", ")}`
    : "Nothing selected";
}

/* ---------- Teams integration (for Submit/Close) ---------- */
let inTeams = false;
if (window.microsoftTeams && microsoftTeams.app) {
  microsoftTeams.app.initialize().then(() => {
    inTeams = true;
  }).catch(() => { /* non-Teams browser */ });
}

function submitToParent(payload) {
  if (inTeams && microsoftTeams.tasks) {
    microsoftTeams.tasks.submitTask(payload); // returns to parent (bot/card)
  } else {
    // Non-Teams fallback: just show what would be returned
    alert("Submit payload:\n" + JSON.stringify(payload, null, 2));
  }
}

/* ---------- Wire up UI ---------- */
document.addEventListener("change", e => {
  if (e.target.classList.contains("row-check")) updateSelectionInfo();
});

$("#btnCloseTop").onclick = $("#btnClose").onclick = () => {
  submitToParent({ cancelled: true });
};

$("#btnSubmitTop").onclick = $("#btnSubmit").onclick = () => {
  const selected = getSelection();
  submitToParent({
    cancelled: false,
    action: "tmSearchSubmit",
    loginUser: $("#loginUser").value,
    selected
  });
};

$("#searchForm").addEventListener("submit", e => {
  e.preventDefault();
  const rows = filterUsers(
    $("#loginUser").value,
    $("#query").value,
    parseInt($("#showCount").value, 10)
  );
  render(rows);
});

/* ---------- Initial load (use query params if present) ---------- */
(function init() {
  const qp = getQueryParams();
  if (qp.loginuser) $("#loginUser").value = qp.loginuser;
  if (qp.show) $("#showCount").value = String(qp.show);
  if (qp.q) $("#query").value = qp.q;

  const rows = filterUsers($("#loginUser").value, $("#query").value, parseInt($("#showCount").value, 10));
  render(rows);
})();
</script>
</body>
</html>
