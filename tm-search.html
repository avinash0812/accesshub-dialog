<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AccessHub – Task Module</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Teams SDK (safe if missing; code guards for browser testing) -->
  <script src="https://res.cdn.office.net/assets/teams-js/2.12.0/js/MicrosoftTeams.min.js"></script>

  <style>
    :root{
      --brand:#165e7c;         /* primary teal-blue */
      --brand-600:#114a62;
      --brand-100:#e7f0f4;
      --ink:#0f172a;           /* text */
      --muted:#475569;         /* secondary text */
      --bdr:#cbd5e1;           /* borders */
      --ok:#0ea5a5;            /* accent (confirm chip, etc.) */
      --danger:#d92d20;        /* error */
      --bg:#ffffff;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.25 "Segoe UI", system-ui, Arial;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 28px;}
    h1{font-size:20px;margin:6px 0 14px;color:var(--ink)}
    h2{font-size:16px;margin:18px 0 8px;color:var(--ink)}
    .card{border:1px solid var(--bdr);border-radius:8px;padding:14px 14px 10px;background:#fff;margin-bottom:12px}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0}            /* tighter vertical rhythm */
    .row.stack{align-items:flex-start}
    .grow{flex:1}
    label{font-weight:600;margin-right:8px}
    input[type="text"], input[type="date"], select, textarea{
      width:100%;border:1px solid var(--bdr);border-radius:6px;padding:8px 10px;font:inherit;outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .btn{
      border:1px solid transparent;border-radius:10px;padding:10px 16px;font-weight:600;
      background:var(--brand);color:#fff;cursor:pointer;transition:.12s;
    }
    .btn:hover{background:var(--brand-600)}
    .btn.outline{background:#fff;color:var(--brand);border-color:var(--brand)}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:14px}
    .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .muted{color:var(--muted);font-size:13px}
    .hr{height:1px;background:var(--bdr);margin:8px 0}
    .chip{
      display:inline-flex;gap:6px;align-items:center;
      background:var(--brand-100);border:1px solid var(--bdr);color:var(--ink);
      border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:14px;
    }
    .chip button{border:0;background:transparent;color:var(--muted);cursor:pointer}
    .list{border:1px solid var(--bdr);border-radius:6px;padding:6px}
    .list .row{margin:2px 0}
    .pill{display:inline-block;background:var(--ok);color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 760px){ .grid{grid-template-columns:1fr} }

    /* mini modal (confirmation) */
    .modal-backdrop{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(520px,90vw);background:#fff;border-radius:12px;border:1px solid var(--bdr);padding:14px}
    .modal h3{margin:4px 0 10px}
    .center{text-align:center}

    /* section visibility */
    .section{display:none}
    .section.active{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Request Actual Access</h1>

    <!-- SECTION 1: Pre-Requisites -->
    <section id="sec-prereq" class="section active">
      <div class="card">
        <h2>Pre-Requisites</h2>
        <div class="row"><div class="grow muted">
          Ensure your **Agreement** and **Training** are completed before proceeding.
        </div></div>

        <div class="list" id="prereqStatus">
          <!-- Filled by JS: Agreement ✓/✗ & Training ✓/✗ -->
        </div>

        <div class="row">
          <button class="btn outline small" id="openAgreement">Open Agreement</button>
          <button class="btn outline small" id="openTraining">Open Training</button>
          <span class="muted">Complete both, then click “Re-check”.</span>
        </div>

        <div class="toolbar">
          <button class="btn outline" id="recheck">Re-check</button>
          <button class="btn" id="goDetails" disabled>Next</button>
        </div>
      </div>
    </section>

    <!-- SECTION 2: Access Details / Search -->
    <section id="sec-access" class="section">
      <div class="card">
        <h2>Access Details</h2>

        <div class="grid">
          <div class="row stack">
            <label for="loginUser">Login User</label>
            <select id="loginUser">
              <!-- JS fills: All, User1.. -->
            </select>
          </div>

          <div class="row stack">
            <label for="take">Show</label>
            <select id="take">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label for="q">Search alias or name</label>
          <input class="grow" id="q" type="text" placeholder="eg. akanoo or Ashish" />
          <button class="btn" id="btnSearch">Search</button>
          <button class="btn outline" id="btnClear">Clear</button>
        </div>

        <div id="results" class="list">
          <!-- Search results render here -->
        </div>

        <div class="hr"></div>

        <h2>Selected Users</h2>
        <div id="selected" class="list">
          <!-- Chips render here -->
        </div>

        <div class="row stack" style="margin-top:6px">
          <label for="duration">Enter Duration <span class="pill" title="Required">*</span></label>
          <input id="duration" type="date" class="grow" />
        </div>
        <div class="muted" style="margin-top:2px">
          Note: The date cannot be today, before today, or beyond the current fiscal year (Jul 25 – Jun 26).
        </div>

        <div class="toolbar">
          <button class="btn outline" id="backPrereq">Back</button>
          <button class="btn" id="nextConfirm">Next</button>
        </div>
      </div>
    </section>

    <!-- Confirmation mini-modal -->
    <div class="modal-backdrop" id="confirmModal">
      <div class="modal">
        <h3>Confirm Selection</h3>
        <div id="confirmList" class="list"></div>
        <div class="row"><span id="confirmDate" class="muted"></span></div>
        <div class="toolbar">
          <button class="btn outline" id="confirmBack">Back</button>
          <button class="btn" id="confirmGo">Confirm</button>
        </div>
      </div>
    </div>

    <!-- SECTION 3: Title & Justification -->
    <section id="sec-title" class="section">
      <div class="card">
        <div class="row">
          <button class="btn outline small" id="toAccess">&larr; Back</button>
        </div>
        <h2>Title</h2>

        <div class="row"><div class="muted">Your current title is considered during approval. Confirm or request a change.</div></div>

        <div class="grid">
          <div class="row stack">
            <label>Current title</label>
            <div class="grow" id="currTitle">Soft-Architect-Service</div>
          </div>
          <div class="row stack">
            <label for="newTitle">Your new title</label>
            <select id="newTitle"></select>
          </div>
        </div>

        <h2>Business Justification</h2>
        <div class="row stack">
          <div class="muted grow">
            Help approvers understand why you need access to the other role.
          </div>
        </div>
        <textarea id="justification" placeholder="Enter Business Justification..."></textarea>

        <div class="toolbar">
          <button class="btn" id="submitTitle">Submit</button>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ------------------------------
    // Teams helpers
    // ------------------------------
    let inTeams = false;
    try {
      microsoftTeams.app.initialize().then(() => { inTeams = true; });
    } catch(e) { /* Running in a browser is fine for POC */ }

    function closeWith(payload){
      if(inTeams){
        microsoftTeams.tasks.submitTask(payload || {});
      }else{
        // Browser fallback
        console.log("submitTask payload:", payload);
        alert("submitTask:\n" + JSON.stringify(payload,null,2));
      }
    }

    // ------------------------------
    // Demo data
    // ------------------------------
    const demoUsers = [
      { loginuser:"User1", alias:"akanoo", name:"Ashish Kanoongo" },
      { loginuser:"User1", alias:"jdoe",   name:"John Doe" },
      { loginuser:"User1", alias:"mshah",  name:"Meera Shah" },
      { loginuser:"User1", alias:"sgeorge",name:"Sam George" },
      { loginuser:"User1", alias:"pk",     name:"Priya K" },
      { loginuser:"User1", alias:"alexr",  name:"Alex R" },
      { loginuser:"User1", alias:"chenl",  name:"Chen Li" },

      { loginuser:"User3", alias:"liamj",  name:"Liam J" },
      { loginuser:"User3", alias:"isham",  name:"Isha M" },
      { loginuser:"User3", alias:"ravin",  name:"Ravi N" },
      { loginuser:"User3", alias:"olgap",  name:"Olga P" },

      { loginuser:"User2", alias:"katew",  name:"Kate W" },
      { loginuser:"User2", alias:"omarh",  name:"Omar H" },
      { loginuser:"User2", alias:"sarab",  name:"Sara B" },
      { loginuser:"User2", alias:"timq",   name:"Tim Q" },
      { loginuser:"User2", alias:"ninad",  name:"Nina D" },
      { loginuser:"User2", alias:"vikz",   name:"Vik Z" },

      { loginuser:"User4", alias:"zedx",   name:"Zed X" },
      { loginuser:"User4", alias:"riak",   name:"Riak" },
      { loginuser:"User4", alias:"dev_1",  name:"Dev One" }
    ];
    // Merge User1 + User3 as requested (for demo)
    const merged = demoUsers.map(u => ({...u, loginuser: (u.loginuser==="User3"?"User1":u.loginuser)}));

    // ------------------------------
    // Lightweight "API" layer for POC
    // Replace these with real HTTP calls to Power Automate / Functions.
    // ------------------------------
    const api = {
      /** TODO (PROD): GET /api/prereqs?loginUser= */
      prereqs: async (loginUser) => {
        // Demo: pretend User1 training/agree true, others false until recheck
        const done = loginUser === "User1";
        return {
          agreementCompleted: done,
          trainingCompleted: done,
          agreementUrl: "https://contoso.example/agreement",
          trainingUrl:  "https://contoso.example/training"
        };
      },

      /** TODO (PROD): GET /api/users?loginUser=&q=&take=&skip= */
      searchUsers: async ({loginUser, q, take}) => {
        let pool = merged;
        if(loginUser && loginUser!=="All"){
          pool = pool.filter(x => x.loginuser===loginUser);
        }
        if(q){
          const s = q.toLowerCase();
          pool = pool.filter(x => x.alias.toLowerCase().includes(s) || x.name.toLowerCase().includes(s));
        }
        pool.sort((a,b) => a.alias.localeCompare(b.alias));
        return { items: pool.slice(0, Number(take) || 20), total: pool.length };
      },

      /** TODO (PROD): GET /api/titles?loginUser= */
      getTitles: async () => ["Architect","Senior Engineer","Manager","Director"],

      /** TODO (PROD): POST /api/requests */
      saveRequest: async (payload) => {
        console.log("POST /api/requests", payload);
        // Return an ID as if SQL created one
        return { requestId: Math.floor(Math.random()*900000)+100000 };
      },

      /** TODO (PROD): POST /api/feedback */
      saveFeedback: async ({requestId, rating, comments}) => {
        console.log("POST /api/feedback", {requestId, rating, comments});
        return { ok: true };
      }
    };

    // ------------------------------
    // State
    // ------------------------------
    let state = {
      loginUser: "All",
      take: 20,
      q: "",
      results: [],
      selected: [],         // [{alias,name}]
      duration: "",         // yyyy-mm-dd
      prereq: {agreementCompleted:false, trainingCompleted:false, agreementUrl:"#", trainingUrl:"#"},
      titles: [],
      newTitle: "",
      justification: ""
    };

    // ------------------------------
    // Helpers
    // ------------------------------
    const $ = sel => document.querySelector(sel);
    function show(sectionId){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      $(sectionId).classList.add("active");
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function todayISO(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function renderPrereqs(){
      const el = $("#prereqStatus");
      const a = state.prereq.agreementCompleted ? "✓" : "✗";
      const t = state.prereq.trainingCompleted ? "✓" : "✗";
      el.innerHTML = `
        <div class="row"><div class="grow"><strong>Agreement</strong> — ${
          state.prereq.agreementCompleted? "<span class='pill'>Completed</span>" : "<span class='muted'>Not completed</span>"
        } (${a})</div></div>
        <div class="row"><div class="grow"><strong>Training</strong> — ${
          state.prereq.trainingCompleted? "<span class='pill'>Completed</span>" : "<span class='muted'>Not completed</span>"
        } (${t})</div></div>
      `;
      $("#openAgreement").onclick = () => window.open(state.prereq.agreementUrl,"_blank");
      $("#openTraining").onclick  = () => window.open(state.prereq.trainingUrl,"_blank");

      const ok = state.prereq.agreementCompleted && state.prereq.trainingCompleted;
      $("#goDetails").disabled = !ok;
    }
    function renderResults(){
      const box = $("#results");
      if(!state.results.length){
        box.innerHTML = `<div class="muted">No results. Try another search.</div>`;
        return;
      }
      box.innerHTML = state.results.map(x => `
        <div class="row">
          <div class="grow"><strong>${x.alias}</strong> — ${x.name}</div>
          <button class="btn small" data-add="${x.alias}">Add</button>
        </div>
      `).join("");
      box.querySelectorAll("[data-add]").forEach(btn=>{
        btn.onclick = () => {
          const alias = btn.getAttribute("data-add");
          const item = state.results.find(r => r.alias===alias);
          if(item && !state.selected.some(s => s.alias===alias)){
            state.selected.push({alias:item.alias, name:item.name});
            state.selected.sort((a,b)=>a.alias.localeCompare(b.alias));
            renderSelected();
          }
        }
      });
    }
    function renderSelected(){
      const s = $("#selected");
      if(!state.selected.length){
        s.innerHTML = `<div class="muted">No users selected yet.</div>`;
        return;
      }
      s.innerHTML = state.selected.map(x => `
        <span class="chip">${x.alias} — ${x.name}
          <button title="remove" data-rm="${x.alias}">✕</button>
        </span>
      `).join("");
      s.querySelectorAll("[data-rm]").forEach(b=>{
        b.onclick = () => {
          const alias = b.getAttribute("data-rm");
          state.selected = state.selected.filter(z => z.alias!==alias);
          renderSelected();
        }
      });
    }
    function openConfirm(){
      // Fill list + date
      $("#confirmList").innerHTML = state.selected.length
        ? state.selected.map(x=>`<div class="row"><div class="grow">${x.alias} — ${x.name}</div></div>`).join("")
        : `<div class="muted">No users selected.</div>`;
      const d = state.duration;
      const dd = d ? d.split("-").reverse().join("/") : "";
      $("#confirmDate").textContent = d ? `Selected for ${dd}` : ``;
      $("#confirmModal").style.display="flex";
    }
    function closeConfirm(){ $("#confirmModal").style.display="none"; }

    // ------------------------------
    // Wire up UI
    // ------------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      // Fill LoginUser with All + distinct users
      const distinct = Array.from(new Set(merged.map(x=>x.loginuser))).sort();
      const loginSel = $("#loginUser");
      loginSel.innerHTML = `<option value="All">All</option>` + distinct.map(u=>`<option>${u}</option>`).join("");
      loginSel.value = "All";

      // Default date = today (and Clear resets to today)
      $("#duration").value = todayISO();

      // Load initial prereqs for demo (use All -> treat as User1 on recheck)
      state.prereq = await api.prereqs("User1");
      renderPrereqs();

      $("#recheck").onclick = async () => {
        const who = $("#loginUser").value==="All" ? "User1" : $("#loginUser").value;
        state.prereq = await api.prereqs(who);
        renderPrereqs();
      };
      $("#goDetails").onclick = () => show("#sec-access");
      $("#backPrereq").onclick = () => show("#sec-prereq");

      $("#btnSearch").onclick = async () => {
        state.loginUser = $("#loginUser").value;
        state.take = Number($("#take").value||20);
        state.q = $("#q").value.trim();
        const { items } = await api.searchUsers({loginUser:state.loginUser, q:state.q, take:state.take});
        state.results = items;
        renderResults();
      };
      $("#btnClear").onclick = () => {
        state.selected = [];
        renderSelected();
        $("#q").value = "";
        $("#duration").value = todayISO(); // reset to today
        $("#results").innerHTML = `<div class="muted">Cleared.</div>`;
      };

      $("#nextConfirm").onclick = ()=>{
        // Validation: must choose date (not today or past) + have >=1 user
        const d = $("#duration").value;
        state.duration = d;
        const today = todayISO();
        if(!d || d<=today){ alert("Please choose a valid future date within fiscal year."); return; }
        if(!state.selected.length){ alert("Please select at least one user."); return; }
        openConfirm();
      };
      $("#confirmBack").onclick = closeConfirm;

      // Confirm → return payload to chat OR go to Screen 3 (based on your flow)
      $("#confirmGo").onclick = async ()=>{
        closeConfirm();
        // Send quick receipt back to chat, then enter Title screen
        closeWith({
          kind:"accessSelection",
          loginUser: state.loginUser,
          duration: state.duration,
          users: state.selected
        });
        // Now proceed to Title (Screen 3)
        // Load titles (demo)
        state.titles = await api.getTitles();
        $("#newTitle").innerHTML = `<option value="">-- Select --</option>` + state.titles.map(t=>`<option>${t}</option>`).join("");
        show("#sec-title");
      };

      $("#toAccess").onclick = () => show("#sec-access");

      $("#submitTitle").onclick = async ()=>{
        const payload = {
          loginUser: state.loginUser,
          duration: state.duration,
          users: state.selected,
          newTitle: $("#newTitle").value || null,
          justification: $("#justification").value || ""
        };

        // TODO (PROD): POST /api/requests (save to Azure SQL)
        const { requestId } = await api.saveRequest(payload);

        // Optional feedback prompt (simple confirm for POC)
        const wants = confirm("Do you want to give feedback?");
        if(wants){
          const comments = prompt("Any feedback to share? (optional)") || "";
          await api.saveFeedback({requestId, rating:5, comments});
        }

        closeWith({ kind:"done", requestId });
      };
    });

  </script>
</body>
</html>
