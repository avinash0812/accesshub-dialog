<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Request Actual Access — Task Module2</title>
<style>
  :root{
    --brand:#0b5f7d;
    --brand-700:#084e65;
    --muted:#6b7280;
    --border:#d9dee5;
    --danger:#cc1f1a;
    --ok:#10b981;
    --bg:#f8fafc;
  }
  html,body{margin:0;background:#fff;color:#111;font-family:Segoe UI, Roboto, Arial, sans-serif}
  .wrap{max-width:1080px;margin:18px auto;padding:0 16px}
  .card{border:1px solid var(--border);border-radius:10px;padding:14px 16px;background:#fff}
  .hdr{display:flex;align-items:center;gap:8px;margin:0 0 10px 0;font-size:18px;font-weight:600}
  .row{display:flex;gap:18px;align-items:center}
  .row>.col{flex:1}
  .mt-6{margin-top:6px}.mt-8{margin-top:8px}.mt-10{margin-top:10px}
  .mb-6{margin-bottom:6px}
  .thin{margin:8px 0;border:0;border-top:1px solid var(--border)}
  label{font-weight:600}
  .req::after{content:" *";color:#e11d48;font-weight:700}
  input[type="text"],input[type="date"],select,textarea{
    width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff
  }
  textarea{min-height:120px;resize:vertical}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:9px 16px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--brand-700)}
  .btn.outline{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .btn.ghost{background:#e7f3f7;color:#083a4a}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:5px 10px;margin:3px 6px 0 0;font-size:13px;background:#f4f7fb}
  .pill .x{cursor:pointer;color:#64748b}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
  .table th{background:#f3f6fb;text-align:left;font-weight:700}
  .error{color:#b91c1c;font-size:13px;margin-top:6px}
  .hint{color:var(--muted);font-size:12px;margin-top:4px}
  .badge-ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:2px 8px;border-radius:999px;font-size:12px}
  .badge-warn{color:#92400e;background:#fffbeb;border:1px solid #fde68a;padding:2px 8px;border-radius:999px;font-size:12px}
  /* compact section spacing */
  .section{margin:8px 0 12px}
  .section h3{margin:0 0 8px 0;font-size:16px}
  /* footer bar */
  .footer{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
  /* modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.38);z-index:50}
  .modal.open{display:grid}
  .modal .panel{width:min(560px,90vw);background:#fff;border-radius:12px;border:1px solid var(--border);box-shadow:0 10px 35px rgba(0,0,0,.25)}
  .modal .phdr{padding:10px 14px;border-bottom:1px solid var(--border);font-weight:700}
  .modal .pbd{padding:12px 14px}
  .modal .pftr{padding:12px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
  .btn.same{min-width:96px}
  /* right-align the feedback box to match outer edge */
  .pbd .feedback-box{width:100%}
  /* compact lists */
  .stack-compact>*{margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="screen1">
    <div class="hdr">Request Actual Access — Pre-Requisites</div>
    <hr class="thin" />
    <div class="section stack-compact">
      <div class="row">
        <div class="col">
          <label>Agreement <span class="req"></span></label>
          <div id="agrStatus"></div>
          <div class="hint">If not completed, open the Agreement in a new tab, finish it, then return here.</div>
        </div>
        <div class="col">
          <label>Training <span class="req"></span></label>
          <div id="trnStatus"></div>
          <div class="hint">If not completed, launch the Training module, then return.</div>
        </div>
      </div>
    </div>
    <div class="footer">
      <button class="btn" id="btn1Next" disabled>Next</button>
    </div>
  </div>

  <div class="card" id="screen2" style="display:none">
    <div class="hdr">Access Details</div>
    <hr class="thin" />
    <div class="row">
      <div class="col">
        <label>Search alias or name</label>
        <div class="row">
          <input id="q" class="col" type="text" placeholder="e.g., jdoe or John" />
          <button class="btn" id="btnSearch" style="min-width:96px">Search</button>
          <button class="btn outline" id="btnClear" style="min-width:96px">Clear</button>
        </div>
        <div class="hint">Sorted A → Z. Click “Add” to select; selected users appear below.</div>
      </div>
      <div class="col">
        <label class="req">Enter Duration</label>
        <input id="dt" type="date" />
        <div id="dateErr" class="error" style="display:none"></div>
        <div class="hint">Must be after today and within the current fiscal year (Jul 25 → Jun 26).</div>
      </div>
    </div>

    <div class="section">
      <table class="table" id="tbl">
        <thead><tr><th style="width:36%">Alias</th><th>Display name</th><th style="width:90px"></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h3>Selected users</h3>
      <div id="chips"></div>
    </div>

    <div class="footer">
      <button class="btn outline" id="btn2Back">Back</button>
      <button class="btn" id="btn2Next" disabled>Next</button>
    </div>
  </div>

  <div class="card" id="screen3" style="display:none">
    <div class="hdr">Title &amp; Business Justification</div>
    <hr class="thin" />
    <div class="row">
      <div class="col">
        <label>Current title</label>
        <div id="curTitle" class="mt-6">Soft-Architect-Service</div>
      </div>
      <div class="col">
        <label>Your new title</label>
        <select id="newTitle">
          <option>Architect</option>
          <option>Principal Architect</option>
          <option>Engineering Manager</option>
          <option>Senior Engineer</option>
          <option>Program Manager</option>
        </select>
      </div>
    </div>

    <div class="mt-10">
      <label class="req">Business Justification</label>
      <div class="row">
        <div class="col"><textarea id="just"></textarea></div>
      </div>
      <div id="justErr" class="error" style="display:none">Please enter a business justification.</div>
    </div>

    <div class="footer">
      <button class="btn outline" id="btn3Back">Back</button>
      <button class="btn" id="btn3Submit">Submit</button>
    </div>
  </div>
</div>

<!-- Feedback modal (centered, compact) -->
<div class="modal" id="mdFeedback" role="dialog" aria-modal="true" aria-labelledby="mdHdr">
  <div class="panel">
    <div class="phdr" id="mdHdr">Feedback</div>
    <div class="pbd">
      <div class="hint" style="margin-bottom:6px">Optional: share quick feedback about this flow.</div>
      <textarea id="fb" class="feedback-box" rows="4" placeholder="Type a few lines…"></textarea>
    </div>
    <div class="pftr">
      <button class="btn outline same" id="fbCancel">Cancel</button>
      <button class="btn same" id="fbOk">OK</button>
    </div>
  </div>
</div>

<script>
  /***********************
   * STATIC DATA (POC only)
   ***********************/
  const PEOPLE = [
    { loginuser:"User1", alias:"akanoo",  name:"User Display" },
    { loginuser:"User1", alias:"jdoe",    name:"User Display" },
    { loginuser:"User1", alias:"mshah",   name:"User Display" },
    { loginuser:"User1", alias:"sgeorge", name:"User Display" },
    { loginuser:"User1", alias:"pk",      name:"User Display" },

    { loginuser:"User2", alias:"katew",   name:"User Display" },
    { loginuser:"User2", alias:"omarh",   name:"User Display" },
    { loginuser:"User2", alias:"sarab",   name:"User Display" },
    { loginuser:"User2", alias:"timq",    name:"User Display" },
    { loginuser:"User2", alias:"ninad",   name:"User Display" },

    { loginuser:"User3", alias:"liamj",   name:"User Display" },
    { loginuser:"User3", alias:"isham",   name:"User Display" },
    { loginuser:"User3", alias:"ravin",   name:"User Display" },
    { loginuser:"User3", alias:"olgap",   name:"User Display" },
    { loginuser:"User3", alias:"alexr",   name:"User Display" },

    { loginuser:"User4", alias:"zedx",    name:"User Display" },
    { loginuser:"User4", alias:"dev_1",   name:"User Display" },
    { loginuser:"User4", alias:"chenl",   name:"User Display" }
  ]
  // For the POC, treat All users as the available set
  const ALL = PEOPLE.slice().sort((a,b)=>a.alias.localeCompare(b.alias))

  /*****************************************
   * PRE-REQUISITES (Screen 1) – demo only
   *****************************************/
  // Demo: pretend we loaded agreement/training status for the logged-in user
  // TODO (PULL): Call your flow/API to retrieve prerequisite flags for user
  const prereq = { agreement:true, training:true }

  const agrStatus = document.getElementById('agrStatus')
  const trnStatus = document.getElementById('trnStatus')
  const btn1Next = document.getElementById('btn1Next')

  function renderPrereq(){
    agrStatus.innerHTML = prereq.agreement
      ? `<span class="badge-ok">Agreement signed</span>`
      : `<span class="badge-warn">Pending — <a href="#" target="_blank">Open Agreement</a></span>`

    trnStatus.innerHTML = prereq.training
      ? `<span class="badge-ok">Training completed</span>`
      : `<span class="badge-warn">Pending — <a href="#" target="_blank">Start Training</a></span>`

    btn1Next.disabled = !(prereq.agreement && prereq.training)
  }
  renderPrereq()

  /*****************************************
   * ACCESS (Screen 2)
   *****************************************/
  const q        = document.getElementById('q')
  const tblBody  = document.querySelector('#tbl tbody')
  const chips    = document.getElementById('chips')
  const dt       = document.getElementById('dt')
  const dateErr  = document.getElementById('dateErr')
  const btn2Next = document.getElementById('btn2Next')

  let selected = new Set() // aliases

  // Default date = today (IST). Clear will also set to today.
  setDateToTodayIST()
  validateDate()

  function toIST(d){
    // Convert device time → IST date (no time)
    const tzOffset = 330 // minutes
    const utc = new Date(d.getTime() + (d.getTimezoneOffset()*60000))
    return new Date(utc.getTime() + tzOffset*60000)
  }
  function todayIST(){
    const t = toIST(new Date())
    return new Date(t.getFullYear(), t.getMonth(), t.getDate())
  }
  function formatYMD(d){ // yyyy-mm-dd
    const m = String(d.getMonth()+1).padStart(2,'0')
    const day = String(d.getDate()).padStart(2,'0')
    return `${d.getFullYear()}-${m}-${day}`
  }
  function setDateToTodayIST(){
    dt.value = formatYMD(todayIST())
  }

  // FY rule: valid range: Jul 25 → Jun 26 (of the *current* FY based on IST "today")
  function fiscalRangeIST(){
    const t = todayIST()
    const y = t.getFullYear()
    const startThisYear = new Date(y, 6, 25) // Jul is month 6 (0-based)
    if (t >= startThisYear){
      // Current FY from Jul 25 (current year) to Jun 26 (next year)
      return { start: startThisYear, end: new Date(y+1, 5, 26) }
    } else {
      // We are before Jul 25 → FY started last year
      return { start: new Date(y-1, 6, 25), end: new Date(y, 5, 26) }
    }
  }

  function validateDate(){
    const v = dt.value ? new Date(dt.value+"T00:00:00") : null
    const t = todayIST()
    const {start,end} = fiscalRangeIST()
    let msg = ""
    if(!v){ msg = "Please select a date."; }
    else if (v <= t){ msg = "Date must be after today (IST)."; }
    else if (v < start || v > end){
      msg = "The date can not be today, before today or later than the current fiscal year (Fiscal year is – July 25 to Jun 26)."
    }
    dateErr.style.display = msg ? 'block':'none'
    dateErr.textContent = msg
    gateNext()
  }

  dt.addEventListener('change', validateDate)

  function gateNext(){
    btn2Next.disabled = !(selected.size>0 && dateErr.style.display==='none')
  }

  function renderTable(list){
    tblBody.innerHTML = ""
    list.forEach(p=>{
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td>${p.alias}</td>
        <td>${p.name}</td>
        <td style="text-align:right">
          <button class="btn btn-add" data-alias="${p.alias}" ${selected.has(p.alias)?"disabled":""}>Add</button>
        </td>`
      tblBody.appendChild(tr)
    })
    tblBody.querySelectorAll('.btn-add').forEach(b=>{
      b.addEventListener('click',()=>{
        selected.add(b.dataset.alias)
        renderChips()
        renderTable(currentList) // disable its add
        gateNext()
      })
    })
  }

  function renderChips(){
    chips.innerHTML = ""
    Array.from(selected).sort().forEach(a=>{
      const el = document.createElement('span')
      el.className = 'pill'
      el.innerHTML = `${a}<span class="x" title="Remove">✕</span>`
      el.querySelector('.x').addEventListener('click',()=>{
        selected.delete(a)
        renderChips()
        renderTable(currentList) // re-enable its add
        gateNext()
      })
      chips.appendChild(el)
    })
  }

  let currentList = ALL.slice()
  renderTable(currentList)

  document.getElementById('btnSearch').addEventListener('click',()=>{
    const t = q.value.trim().toLowerCase()
    currentList = t
      ? ALL.filter(p=>p.alias.toLowerCase().includes(t) || p.name.toLowerCase().includes(t))
      : ALL.slice()
    renderTable(currentList)
  })
  document.getElementById('btnClear').addEventListener('click',()=>{
    q.value = ""
    currentList = ALL.slice()
    renderTable(currentList)
    selected.clear()
    renderChips()
    setDateToTodayIST()      // per your request
    validateDate()
  })

  /*****************************************
   * TITLE / JUSTIFICATION (Screen 3)
   *****************************************/
  const just = document.getElementById('just')
  const justErr = document.getElementById('justErr')

  function validateJust(){
    const ok = just.value.trim().length>0
    justErr.style.display = ok ? 'none':'block'
    return ok
  }
  just.addEventListener('input', validateJust)

  /*****************************************
   * NAVIGATION
   *****************************************/
  const s1 = document.getElementById('screen1')
  const s2 = document.getElementById('screen2')
  const s3 = document.getElementById('screen3')

  btn1Next.addEventListener('click',()=>{ s1.style.display='none'; s2.style.display='block' })
  document.getElementById('btn2Back').addEventListener('click',()=>{ s2.style.display='none'; s1.style.display='block' })
  document.getElementById('btn2Next').addEventListener('click',()=>{ s2.style.display='none'; s3.style.display='block' })
  document.getElementById('btn3Back').addEventListener('click',()=>{ s3.style.display='none'; s2.style.display='block' })

  /*****************************************
   * SUBMIT → FEEDBACK MODAL
   *****************************************/
  const md = document.getElementById('mdFeedback')
  const fb = document.getElementById('fb')
  document.getElementById('btn3Submit').addEventListener('click',()=>{
    if(!validateJust()) return
    // TODO (PUSH): send payload to Flow/API before opening feedback if desired
    //   payload example:
    //   {
    //     duration: dt.value, users: [...selected], newTitle: newTitle.value,
    //     justification: just.value
    //   }
    md.classList.add('open')
    fb.value=""
    fb.focus()
  })
  document.getElementById('fbCancel').addEventListener('click',()=> md.classList.remove('open'))
  document.getElementById('fbOk').addEventListener('click',()=>{
    // TODO (PUSH): send feedback text in `fb.value` to Flow/API
    // Close Task Module (Teams) if available; fallback to close tab
    try{
      if (window.microsoftTeams && microsoftTeams.tasks){
        microsoftTeams.tasks.submitTask({ ok:true })
      }else{
        window.close()
      }
    }catch{ window.close() }
  })

  /*****************************************
   * INTEGRATION NOTES (Power Automate / API)
   *****************************************/
  /*
   PULL (when screen loads):
     - GET /user/{id}/prerequisites  → { agreement:boolean, training:boolean }
     - GET /people?loginUser={id}    → list of people for the table (or use server-side search)

   PUSH:
     - POST /request/access
       body: {
         duration: "YYYY-MM-DD",
         users: ["alias1","alias2",...],
         newTitle: "Architect",
         justification: "text..."
       }
     - POST /feedback
       body: { text:"..." }

   You can call Power Automate flows by exposing them as HTTP request triggers
   or by having your web page call a light-weight API (Azure Functions) which
   then invokes the Flow. Keep payloads small; keep the table server-paged for scale.
  */
</script>
</body>
</html>
