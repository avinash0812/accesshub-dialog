<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Request Actual Access — Search1</title>
<style>
  :root{
    --teams-bg:#f5f5f7; --card:#fff; --text:#1f2937; --muted:#6b7280;
    --border:#e5e7eb; --primary:#2563eb; --primary-pressed:#1e4fc7;
    --accent:#dbeafe; --pill:#eef2ff; --pill-text:#1e40af; --danger:#b91c1c;
    --radius:14px;
  }
  html,body{margin:0;height:100%;background:var(--teams-bg);color:var(--text);
    font-family:Segoe UI,Arial,sans-serif}
  .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:24px}
  .card{width:min(1100px,95vw);background:var(--card);border:1px solid var(--border);
    border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px}
  .title{font-weight:700;font-size:20px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .muted{color:var(--muted);font-size:12px}
  .toolbar{display:grid;gap:10px;grid-template-columns:260px 140px 1fr 110px}
  label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  select,input[type="text"],input[type="date"]{height:40px;border:1px solid var(--border);
    border-radius:10px;padding:0 12px;background:#fff;width:100%;font-size:14px;outline:none}
  .btn{height:40px;border:0;border-radius:10px;padding:0 16px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.primary:hover{background:var(--primary-pressed)}
  .btn.ghost{background:#fff;border:1px solid var(--border)}
  .right{display:flex;gap:8px;justify-content:flex-end;align-items:center}
  .sep{height:1px;background:var(--border);margin:12px 0}
  /* Table (tighter) */
  table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px}
  thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
  tbody tr{background:#fff;border:1px solid var(--border);border-radius:12px}
  tbody td{padding:10px}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .pill{display:inline-block;background:var(--pill);color:var(--pill-text);
    border-radius:999px;padding:2px 10px;font-size:12px}
  /* Selected users chips row */
  .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border:1px solid var(--border);
    border-radius:10px;min-height:44px}
  .chip{background:var(--accent);color:#1e3a8a;border-radius:999px;padding:4px 10px;font-size:12px}
  /* Section header with blue underline */
  .section h3{margin:14px 0 6px;font-size:16px}
  .underline{height:6px;background:#bfd2ff;border-radius:3px;margin:-4px 0 8px;width:280px}
  /* Validation */
  .error{color:var(--danger);font-size:12px;margin-top:6px}
  /* Footer */
  .footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;
    align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border:1px solid var(--border);border-radius:14px;
    width:min(560px,92vw);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal h4{margin:0 0 8px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="dialog" aria-label="Request Actual Access — Search">
    <div class="header">
      <div class="title">Request Actual Access — Search</div>
      <div class="muted"><span id="selCount">0</span> selected</div>
    </div>

    <!-- Search toolbar -->
    <div class="toolbar">
      <div>
        <label>Login User</label>
        <select id="loginUser">
          <option value="All" selected>All (User1 + User3)</option>
          <option value="User1">User1</option>
          <option value="User2">User2</option>
          <option value="User3">User3</option>
          <option value="User4">User4</option>
        </select>
      </div>
      <div>
        <label>Show</label>
        <select id="showCount">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div>
        <label>Search alias or name</label>
        <input id="query" type="text" placeholder="e.g., akanoo or Ashish Kanoongo"/>
      </div>
      <div class="right">
        <button id="btnSearch" class="btn primary">Search</button>
      </div>
    </div>

    <div class="muted" style="margin-top:6px">
      Button-based search (no type-ahead) for performance. Sorted by alias A→Z.
    </div>

    <div class="sep"></div>

    <!-- Selected Users -->
    <div class="section">
      <h3>Selected Users</h3>
      <div class="underline"></div>
      <div id="chipRow" class="chips" aria-live="polite"></div>
    </div>

    <!-- Results table -->
    <table aria-label="Search results">
      <thead>
        <tr>
          <th style="width:44px;"><input id="chkAll" type="checkbox" title="Select all on page"/></th>
          <th style="width:140px;">Alias</th>
          <th>Name</th>
          <th style="width:160px;">Login User</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="sep"></div>

    <!-- Access Duration -->
    <div class="section">
      <h3>Access Duration</h3>
      <div class="underline"></div>
      <label for="dt">Enter Duration <span style="color:#b91c1c">*</span></label>
      <div style="display:grid;grid-template-columns:260px auto;gap:12px;align-items:center">
        <input id="dt" type="date"/>
        <div class="muted">
          <div>Note:</div>
          <div>1. Date cannot be today or before today.</div>
          <div>2. Date cannot be after the current fiscal year end (Jul&nbsp;25 → Jun&nbsp;26).</div>
        </div>
      </div>
      <div id="dtErr" class="error" role="alert" aria-live="polite"></div>
    </div>

    <div class="footer">
      <span class="muted">Review selections and choose a valid duration.</span>
      <div class="right">
        <button class="btn ghost" onclick="window.close()">Close</button>
        <button id="btnNext" class="btn primary">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Centered modal -->
<div id="modalHost" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h4 id="modalTitle">Confirm submission</h4>
    <div id="modalBody" class="muted"></div>
    <div class="sep"></div>
    <div class="right">
      <button id="btnCancel" class="btn ghost">Cancel</button>
      <button id="btnConfirm" class="btn primary">Confirm</button>
    </div>
  </div>
</div>

<script>
/* ---------- Static dataset (POC) ---------- */
const DATA = [
  { loginuser:"User1", alias:"akanoo",  name:"Ashish Kanoongo" },
  { loginuser:"User1", alias:"jdoe",    name:"John Doe" },
  { loginuser:"User1", alias:"mshah",   name:"Meera Shah" },
  { loginuser:"User1", alias:"sgeorge", name:"Sam George" },
  { loginuser:"User1", alias:"pk",      name:"Priya K" },
  { loginuser:"User1", alias:"alexr",   name:"Alex R" },
  { loginuser:"User1", alias:"chenl",   name:"Chen Li" },

  { loginuser:"User2", alias:"katew",   name:"Kate W" },
  { loginuser:"User2", alias:"omarh",   name:"Omar H" },
  { loginuser:"User2", alias:"sarab",   name:"Sara B" },
  { loginuser:"User2", alias:"timq",    name:"Tim Q" },
  { loginuser:"User2", alias:"ninad",   name:"Nina D" },
  { loginuser:"User2", alias:"vikz",    name:"Vik Z" },

  { loginuser:"User3", alias:"liamj",   name:"Liam J" },
  { loginuser:"User3", alias:"isham",   name:"Isha M" },
  { loginuser:"User3", alias:"ravin",   name:"Ravi N" },
  { loginuser:"User3", alias:"olgap",   name:"Olga P" },

  { loginuser:"User4", alias:"zedx",    name:"Zed X" },
  { loginuser:"User4", alias:"riak",    name:"Riak" },
  { loginuser:"User4", alias:"dev_1",   name:"Dev One" },
];

/* ---------- Elements ---------- */
const elLogin   = document.getElementById('loginUser');
const elShow    = document.getElementById('showCount');
const elQuery   = document.getElementById('query');
const elRows    = document.getElementById('rows');
const elSelCnt  = document.getElementById('selCount');
const elChkAll  = document.getElementById('chkAll');
const elChipRow = document.getElementById('chipRow');
const elDt      = document.getElementById('dt');
const elDtErr   = document.getElementById('dtErr');
const modalHost = document.getElementById('modalHost');
const modalBody = document.getElementById('modalBody');

/* ---------- QS init ---------- */
const qs = new URLSearchParams(location.search);
function initFromQuery(){
  const qUser = qs.get('loginuser');
  const qShow = qs.get('show');
  const qText = qs.get('q');
  if (["All","User1","User2","User3","User4"].includes(qUser)) elLogin.value = qUser;
  if (qShow && !Number.isNaN(+qShow)) elShow.value = qShow;
  if (qText) elQuery.value = qText;
}

/* ---------- Data view ---------- */
function currentDataset(){
  if (elLogin.value === "All")
    return DATA.filter(x => x.loginuser === "User1" || x.loginuser === "User3");
  return DATA.filter(x => x.loginuser === elLogin.value);
}

function search(){
  const q = (elQuery.value || "").trim().toLowerCase();
  let list = currentDataset();
  if (q){
    list = list.filter(x =>
      x.alias.toLowerCase().includes(q) ||
      (x.name||"").toLowerCase().includes(q)
    );
  }
  list.sort((a,b)=> a.alias.localeCompare(b.alias));
  const take = Math.max(1, +elShow.value || 20);
  render(list.slice(0, take));
}

function render(items){
  elRows.innerHTML = "";
  elChkAll.checked = false;
  updateCount();

  if (!items.length){
    elRows.innerHTML = `<tr><td colspan="4" class="muted" style="padding:16px;">No results.</td></tr>`;
    return;
  }

  for (const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-alias="${it.alias}" data-name="${escapeHtml(it.name||"")}"></td>
      <td><span class="pill">${it.alias}</span></td>
      <td>${escapeHtml(it.name||"")}</td>
      <td>${it.loginuser}</td>`;
    elRows.appendChild(tr);
  }

  document.querySelectorAll('.rowchk').forEach(cb=>{
    cb.addEventListener('change', ()=>{ updateCount(); renderChips(); });
  });
  renderChips();
}

function getSelectedAliases(){
  return [...document.querySelectorAll('.rowchk:checked')].map(x=>x.dataset.alias);
}
function getSelectedNames(){
  return [...document.querySelectorAll('.rowchk:checked')].map(x=>x.dataset.name);
}

function updateCount(){
  elSelCnt.textContent = getSelectedAliases().length;
}

function renderChips(){
  const aliases = getSelectedAliases();
  elChipRow.innerHTML = aliases.length
    ? aliases.map(a=>`<span class="chip mono">${a}</span>`).join("")
    : `<span class="muted">No users selected.</span>`;
}

/* ---------- Date rules ---------- */
function fiscalBounds(d){
  // FY: Jul 25 -> Jun 26
  const y = d.getFullYear();
  const july25_this = new Date(y, 6, 25); // month 6 = July
  let start, end;
  if (d >= july25_this){
    start = new Date(y, 6, 25);
    end   = new Date(y+1, 5, 26); // Jun 26 next year
  } else {
    start = new Date(y-1, 6, 25);
    end   = new Date(y, 5, 26);   // Jun 26 this year
  }
  return {start,end};
}
function toISO(d){ return d.toISOString().slice(0,10); }
function formatDMY(d){
  return String(d.getDate()).padStart(2,'0') + "/" +
         String(d.getMonth()+1).padStart(2,'0') + "/" +
         d.getFullYear();
}
function validateDate(){
  elDtErr.textContent = "";
  if (!elDt.value) return false;
  const picked = new Date(elDt.value + "T00:00:00");
  const today = new Date(); today.setHours(0,0,0,0);
  if (+picked <= +today){ elDtErr.textContent = "Please choose a date after today."; return false; }
  const {end} = fiscalBounds(today);
  if (+picked > +end){ elDtErr.textContent = `Date must be on or before ${formatDMY(end)} (FY end).`; return false; }
  return true;
}

/* ---------- Modal ---------- */
function openModal(html){
  modalBody.innerHTML = html;
  modalHost.style.display = "flex";
  modalHost.setAttribute("aria-hidden","false");
}
function closeModal(){
  modalHost.style.display = "none";
  modalHost.setAttribute("aria-hidden","true");
}

/* ---------- Events ---------- */
document.getElementById('btnSearch').addEventListener('click', search);
elLogin.addEventListener('change', search);
elShow.addEventListener('change', search);
elChkAll.addEventListener('change', ()=>{
  const checks = document.querySelectorAll('.rowchk');
  checks.forEach(cb => cb.checked = elChkAll.checked);
  updateCount(); renderChips();
});
elDt.addEventListener('change', validateDate);

document.getElementById('btnNext').addEventListener('click', ()=>{
  if (!validateDate()) { elDt.focus(); return; }
  const aliases = getSelectedAliases();
  const when = new Date(elDt.value + "T00:00:00");
  const list = aliases.length ? aliases.map(a=>`<div class="mono">${a}</div>`).join("") : "<div>(none selected)</div>";
  openModal(`
    <div>Following user(s) are selected for <b>${formatDMY(when)}</b>:</div>
    <div style="margin-top:8px">${list}</div>
  `);
});

document.getElementById('btnCancel').addEventListener('click', closeModal);
document.getElementById('btnConfirm').addEventListener('click', ()=>{
  const payload = {
    loginUser: elLogin.value,
    date: elDt.value,
    aliases: getSelectedAliases()
  };
  // POC: show result. In production, postMessage or call API.
  alert("Submitting:\n" + JSON.stringify(payload,null,2));
  closeModal();
});

/* ---------- Boot ---------- */
(function boot(){
  // set date bounds in control (min: tomorrow, max: FY end)
  const today = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(+today + 86400000);
  const {end} = fiscalBounds(today);
  elDt.min = toISO(tomorrow);
  elDt.max = toISO(end);

  initFromQuery();
  search();
})();
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
</script>
</body>
</html>
