<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Request Actual Access — Task Module1</title>
<style>
  :root{
    --brand:#145d79; --brand-dark:#0e4a61; --text:#1b1f23; --muted:#6b7280;
    --bg:#f7fafc; --card:#ffffff; --line:#e6e8ea; --danger:#c62828; --ok:#1c7f4e;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 "Segoe UI",system-ui,Arial,sans-serif}
  .wrap{max-width:1040px;margin:24px auto;padding:0 18px}
  h1{font-size:22px;margin:0 0 10px}
  .bar{height:4px;background:var(--brand);border-radius:3px;margin:8px 0 10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px}
  .stack{display:grid;gap:14px}
  .row{display:grid;grid-template-columns:180px 1fr;gap:10px 14px;align-items:center;margin:2px 0}
  .lbl{font-weight:600}
  .hint{font-size:12px;color:var(--muted)}
  .star{color:var(--danger);margin-left:4px}
  input[type="text"],select,textarea,input[type="date"]{
    width:100%;max-width:520px;border:1px solid var(--line);border-radius:8px;padding:10px 12px;background:#fff;outline:none
  }
  input[type="date"]{max-width:260px}
  input:focus,select:focus,textarea:focus{border-color:var(--brand)}
  textarea{min-height:86px;resize:vertical}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 18px;font-weight:600;color:#fff;background:var(--brand);cursor:pointer}
  .btn:hover{background:var(--brand-dark)}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--text)}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:4px}
  .actions.l{justify-content:flex-start}
  .pill{display:inline-block;border-radius:999px;background:#ecf5f8;color:#074254;padding:6px 10px;font-weight:600}
  .table{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left}
  th{background:#f1f5f9;font-weight:600}
  tr:last-child td{border-bottom:0}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center;margin:4px 6px 0 0;background:#fff}
  .chip .x{width:18px;height:18px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--line);cursor:pointer}
  .warn{color:var(--danger);font-size:12px;margin-top:4px}
  .ok{color:var(--ok);font-size:12px;margin-top:4px}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .sheet{width:min(640px,95vw);background:#fff;border-radius:14px;border:1px solid var(--line);box-shadow:0 10px 26px rgba(0,0,0,.15)}
  .sheet .hd{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .sheet .bd{padding:16px}
  .sheet .ft{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px}
  .btn.w{min-width:110px;text-align:center}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .right-col{display:grid;align-content:start;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Request Actual Access</h1>
  <div class="bar"></div>

  <!-- Screen 0: PRE-REQUISITES -->
  <section id="sec-prereq" class="card stack">
    <div class="row"><div class="lbl">Pre-Requisites</div><div class="hint">Complete both items before continuing.</div></div>

    <div class="row">
      <div class="lbl">Agreement <span class="star">*</span></div>
      <div>
        <span id="agState" class="pill">Pending</span>
        <div class="actions l" style="gap:8px;margin-top:6px">
          <button class="btn" id="agOpen">Open</button>
          <button class="btn ghost" id="agDone">Mark completed</button>
        </div>
        <!-- TODO (pull): Set Agreement from API/Flow -->
      </div>
    </div>

    <div class="row">
      <div class="lbl">Training <span class="star">*</span></div>
      <div>
        <span id="trState" class="pill">Pending</span>
        <div class="actions l" style="gap:8px;margin-top:6px">
          <button class="btn" id="trOpen">Open</button>
          <button class="btn ghost" id="trDone">Mark completed</button>
        </div>
        <!-- TODO (pull): Set Training from API/Flow -->
      </div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="btnClose0">Close</button>
      <button class="btn" id="btnNext0" disabled>Next</button>
    </div>
  </section>

  <!-- Screen 1: SEARCH / SELECT -->
  <section id="sec-search" class="card stack" style="display:none">
    <div class="row"><div class="lbl">Login user</div><div><select id="ddLogin"></select> <span class="hint">Pick a demo user. <b>All</b> shows everyone.</span></div></div>
    <div class="row"><div class="lbl">Show</div><div><select id="ddTop"><option value="10">Top 10</option><option value="20" selected>Top 20</option><option value="50">Top 50</option><option value="-1">All</option></select></div></div>
    <div class="row">
      <div class="lbl">Search alias or name</div>
      <div class="actions l">
        <input id="txtQ" type="text" placeholder="Type alias or display name…" />
        <button class="btn" id="btnSearch">Search</button>
        <button class="btn ghost" id="btnClear">Clear</button>
      </div>
    </div>
    <div class="row">
      <div class="lbl">Selected users <span class="star">*</span></div>
      <div id="selChips"></div>
    </div>
    <div class="row">
      <div class="lbl">Enter duration <span class="star">*</span></div>
      <div>
        <input id="dtDuration" type="date" />
        <div id="dtHint" class="hint">After today and ≤ fiscal year end (IST).</div>
        <div id="dtError" class="warn" style="display:none"></div>
      </div>
    </div>

    <div class="table" id="resultsBox" style="display:none">
      <table id="tbl"><thead><tr><th style="width:30%">Alias</th><th>Display name</th><th style="width:110px"></th></tr></thead><tbody></tbody></table>
    </div>

    <div class="actions">
      <button class="btn ghost" id="btnBack0">Back</button>
      <button class="btn ghost" id="btnClose1">Close</button>
      <button class="btn" id="btnNext" disabled>Next</button>
    </div>
  </section>

  <!-- Screen 2: TITLE / JUSTIFICATION -->
  <section id="sec-title" class="card stack" style="display:none">
    <div class="row"><div class="lbl">Title</div><div class="bar" style="height:3px;margin:0"></div></div>
    <div class="two">
      <div class="row"><div class="lbl">Current title</div><div id="curTitle" class="pill">Soft-Architect-Service</div></div>
      <div class="right-col">
        <div class="lbl">Your new title</div>
        <select id="ddTitles"><option>Architect</option><option>Senior Engineer</option><option>Manager</option><option>Director</option></select>
      </div>
    </div>
    <div class="row">
      <div class="lbl">Business justification <span class="star">*</span></div>
      <div>
        <textarea id="txtJust" placeholder="Explain briefly why this access is needed…"></textarea>
        <div id="justErr" class="warn" style="display:none">Business justification is required.</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnBack1">Back</button>
      <button class="btn ghost" id="btnClose2">Close</button>
      <button class="btn" id="btnSubmitTitle" disabled>Submit</button>
    </div>
  </section>
</div>

<!-- Confirm -->
<div class="modal" id="mConfirm">
  <div class="sheet">
    <div class="hd">Confirm selection</div>
    <div class="bd"><div id="confirmTxt"></div></div>
    <div class="ft"><button class="btn ghost w" id="mcCancel">Cancel</button><button class="btn w" id="mcOk">Confirm</button></div>
  </div>
</div>
<!-- Feedback -->
<div class="modal" id="mFeedback">
  <div class="sheet" style="width:min(520px,95vw)">
    <div class="hd">Feedback</div>
    <div class="bd">
      <div class="hint" style="margin:0 0 6px">Optional: share quick feedback about this flow.</div>
      <textarea id="txtFb" style="width:100%"></textarea>
    </div>
    <div class="ft"><button class="btn ghost w" id="mfCancel">Cancel</button><button class="btn w" id="mfOk">OK</button></div>
  </div>
</div>

<script>
/* ===== Demo users (User1 + User3 clubbed) ===== */
const USERS = [
  { loginuser:"User1", alias:"akanoo", name:"User Display" },
  { loginuser:"User1", alias:"jdoe",   name:"User Display" },
  { loginuser:"User1", alias:"mshah",  name:"User Display" },
  { loginuser:"User1", alias:"sgeorge",name:"User Display" },
  { loginuser:"User1", alias:"pk",     name:"User Display" },
  { loginuser:"User1", alias:"alexr",  name:"User Display" },
  { loginuser:"User1", alias:"chenl",  name:"User Display" },
  { loginuser:"User1", alias:"liamj",  name:"User Display" },
  { loginuser:"User1", alias:"isham",  name:"User Display" },
  { loginuser:"User1", alias:"ravin",  name:"User Display" },
  { loginuser:"User1", alias:"olgap",  name:"User Display" },
  { loginuser:"User2", alias:"katew",  name:"User Display" },
  { loginuser:"User2", alias:"omarh",  name:"User Display" },
  { loginuser:"User2", alias:"sarab",  name:"User Display" },
  { loginuser:"User2", alias:"timq",   name:"User Display" },
  { loginuser:"User2", alias:"ninad",  name:"User Display" },
  { loginuser:"User2", alias:"vikz",   name:"User Display" },
  { loginuser:"User4", alias:"zedx",   name:"User Display" },
  { loginuser:"User4", alias:"riak",   name:"User Display" },
  { loginuser:"User4", alias:"dev_1",  name:"User Display" },
].sort((a,b)=>a.alias.localeCompare(b.alias));

/* ===== sections & controls ===== */
const sec0=document.getElementById('sec-prereq');
const secSearch=document.getElementById('sec-search');
const secTitle=document.getElementById('sec-title');

const agState=document.getElementById('agState');
const trState=document.getElementById('trState');
const btnNext0=document.getElementById('btnNext0');
document.getElementById('agOpen').onclick=()=>window.open('#','_blank');
document.getElementById('trOpen').onclick=()=>window.open('#','_blank');
document.getElementById('agDone').onclick=()=>{agState.textContent='Completed';agState.className='pill';checkPrereq();}
document.getElementById('trDone').onclick=()=>{trState.textContent='Completed';trState.className='pill';checkPrereq();}
document.getElementById('btnClose0').onclick=closeTask;
document.getElementById('btnNext0').onclick=()=>{sec0.style.display='none';secSearch.style.display='block';};
function checkPrereq(){ btnNext0.disabled = !(agState.textContent==='Completed' && trState.textContent==='Completed'); }
checkPrereq();

/* Back buttons */
document.getElementById('btnBack0').onclick=()=>{secSearch.style.display='none';sec0.style.display='block';};
document.getElementById('btnBack1').onclick=()=>{secTitle.style.display='none';secSearch.style.display='block';};
document.getElementById('btnClose1').onclick=closeTask;
document.getElementById('btnClose2').onclick=closeTask;

/* ===== Search screen ===== */
const ddLogin=document.getElementById('ddLogin');
const ddTop=document.getElementById('ddTop');
const txtQ=document.getElementById('txtQ');
const btnSearch=document.getElementById('btnSearch');
const btnClear=document.getElementById('btnClear');
const tblBody=document.querySelector('#tbl tbody');
const resultsBox=document.getElementById('resultsBox');
const chips=document.getElementById('selChips');
const dt=document.getElementById('dtDuration');
const dtErr=document.getElementById('dtError');
const btnNext=document.getElementById('btnNext');

/* Populate login dropdown */
(function(){
  const set=new Set(USERS.map(u=>u.loginuser));
  ddLogin.innerHTML=['All',...set].map(u=>`<option>${u}</option>`).join('');
})();

const selected=new Set();

/* === India time helpers === */
function isoFromIST(d){ // returns YYYY-MM-DD from a Date treated in IST
  const tz='Asia/Kolkata';
  const parts=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  const map=Object.fromEntries(parts.map(p=>[p.type,p.value]));
  return `${map.year}-${map.month}-${map.day}`;
}
function istTodayISO(){ return isoFromIST(new Date()); }
function istFiscalEndISO(){
  // FY: Jul 25 (Y) to Jun 26 (Y+1) in IST
  const now=new Date();
  // month is 0-index: 6 = July
  const tz='Asia/Kolkata';
  const parts=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric'}).formatToParts(now);
  const year=Number(parts.find(p=>p.type==='year').value);
  const afterJul24 = (new Date().getMonth()>6) || (new Date().getMonth()===6 && new Date().getDate()>=25);
  const startYear = afterJul24 ? year : year-1;
  const end = new Date(Date.UTC(startYear+1,5,26,0,0,0)); // Jun 26
  return isoFromIST(end);
}

/* init date; no error until touched */
let dtTouched=false;
dt.max=istFiscalEndISO();
dt.addEventListener('change',()=>{dtTouched=true;validateDuration(true);});
dt.addEventListener('input',()=>{dtTouched=true;validateDuration(true);});

function validateDuration(showImmediately=false){
  const today=istTodayISO();
  const max=dt.max;
  const v=dt.value;

  let ok=true,msg='';
  if(!v){ ok=false; msg='Please choose a date.'; }
  else if(v<=today){ ok=false; msg='Date must be after today (IST).'; }
  else if(v>max){ ok=false; msg=`Date must be on or before ${max}.`; }

  const shouldShow = showImmediately || dtTouched;
  dtErr.style.display = ok || !shouldShow ? 'none' : 'block';
  dtErr.textContent  = ok ? '' : msg;

  updateNextState();
  return ok;
}

/* search render */
function pool(){return ddLogin.value==='All'?USERS:USERS.filter(u=>u.loginuser===ddLogin.value)}
function runSearch(){
  const q=txtQ.value.trim().toLowerCase();
  let rows=pool().filter(u=>!q||u.alias.toLowerCase().includes(q)||u.name.toLowerCase().includes(q));
  const top=parseInt(ddTop.value,10); if(top>0) rows=rows.slice(0,top);
  renderTable(rows); updateNextState();
}
function renderTable(rows){
  resultsBox.style.display=rows.length?'block':'none';
  const s=new Set(selected);
  tblBody.innerHTML=rows.map(u=>`<tr>
      <td><code>${u.alias}</code></td>
      <td>${u.name}</td>
      <td><button class="btn" data-add="${u.alias}" ${s.has(u.alias)?'disabled':''}>${s.has(u.alias)?'Added':'Add'}</button></td>
    </tr>`).join('');
}
function rebuildChips(){
  chips.innerHTML=[...selected].sort().map(a=>`<span class="chip"><code>${a}</code><span class="x" data-x="${a}">×</span></span>`).join('');
  document.querySelectorAll('[data-add]').forEach(b=>{const a=b.getAttribute('data-add');const s=selected.has(a);b.disabled=s;b.textContent=s?'Added':'Add'});
  updateNextState();
}
function updateNextState(){
  const justOk = document.getElementById('txtJust').value.trim().length>0;
  btnNext.disabled = !(selected.size>0 && !dtErr.textContent && dt.value);
  document.getElementById('btnSubmitTitle').disabled = !justOk;
}

btnSearch.onclick=runSearch;
ddLogin.onchange=runSearch;
ddTop.onchange=runSearch;
txtQ.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();runSearch()}});

btnClear.onclick=()=>{ txtQ.value=''; dt.value=''; dtTouched=false; dtErr.style.display='none'; runSearch(); };

document.addEventListener('click',e=>{
  const a=e.target.getAttribute?.('data-add'); if(a){selected.add(a); rebuildChips(); return;}
  const x=e.target.getAttribute?.('data-x'); if(x){selected.delete(x); rebuildChips(); return;}
});

/* Next -> confirm */
const mConfirm=document.getElementById('mConfirm');
const confirmTxt=document.getElementById('confirmTxt');
document.getElementById('mcCancel').onclick=()=>mConfirm.classList.remove('show');
document.getElementById('mcOk').onclick=()=>{mConfirm.classList.remove('show'); secSearch.style.display='none'; secTitle.style.display='block';
  // TODO (pull): hydrate current title/dropdown from backend using selection + date
};
btnNext.onclick=()=>{
  if(!(validateDuration(true) && selected.size>0)) return;
  const [y,m,d]=dt.value.split('-'); const when=`${d}/${m}/${y}`;
  confirmTxt.innerHTML=`<div>Following users are selected for <b>${when}</b>:</div><div style="margin-top:6px">${[...selected].sort().map(a=>`<div>• <code>${a}</code></div>`).join('')}</div>`;
  mConfirm.classList.add('show');
};

/* ===== Title / justification (inline validation) ===== */
const txtJust=document.getElementById('txtJust');
const justErr=document.getElementById('justErr');
txtJust.addEventListener('input',()=>{
  const ok=txtJust.value.trim().length>0;
  justErr.style.display= ok ? 'none' : 'block';
  updateNextState();
});
document.getElementById('btnSubmitTitle').onclick=()=>{
  const ok = txtJust.value.trim().length>0;
  justErr.style.display = ok ? 'none' : 'block';
  if(!ok) return;
  // proceed to optional feedback
  mFeedback.classList.add('show');
};

/* Feedback modal */
const mFeedback=document.getElementById('mFeedback');
document.getElementById('mfCancel').onclick=()=>mFeedback.classList.remove('show');
document.getElementById('mfOk').onclick=()=>{
  mFeedback.classList.remove('show');
  const payload={
    action:"request_actual_access",
    loginuser:ddLogin.value,
    aliases:[...selected].sort(),
    duration:dt.value,
    newTitle:document.getElementById('ddTitles').value,
    justification:txtJust.value.trim(),
    feedback:document.getElementById('txtFb').value.trim()
  };
  // TODO (push): send payload to Power Automate / API for Azure SQL persistence
  closeTask(payload);
};

/* Close helper */
function closeTask(payload={}){
  try{ if(window.microsoftTeams?.tasks?.submitTask){ window.microsoftTeams.tasks.submitTask(payload); return; } }catch(e){}
  try{ window.parent.postMessage({type:'tm-close',payload},'*'); }catch(e){}
}

/* init screen */
validateDuration(false); runSearch();
</script>
</body>
</html>

