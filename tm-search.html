<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Request Actual Access — Task Module</title>
<style>
  :root{
    --brand:#0e5a73;           /* teal */
    --brand-dark:#0b495d;
    --fg:#0f172a;
    --muted:#6b7280;
    --bg:#f8fafc;
    --card:#ffffff;
    --danger:#b91c1c;
    --ok:#065f46;
    --row-h:28px;              /* tighter rows */
    --radius:10px;
    --btnw:96px;               /* consistent button width */
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .shell{max-width:1100px;margin:24px auto;padding:0 16px;}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px;}
  .hdr{display:flex;align-items:center;gap:12px;margin:0 0 14px 0}
  .hdr h1{font-size:20px;margin:0}
  .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
  .bar-right{display:flex;align-items:center;gap:12px}
  .btn{appearance:none;border:0;background:var(--brand);color:#fff;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;min-width:var(--btnw);text-align:center}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .btn:hover{background:var(--brand-dark)}
  .row{display:flex;gap:16px;align-items:center;margin:6px 0}
  .row > *{flex:1}
  .grid-2{display:grid;grid-template-columns:1fr 420px;gap:16px;align-items:start}
  label{font-weight:700}
  .req::after{content:" *"; color:var(--danger); font-weight:800}
  input[type="date"],input[type="text"],textarea,select{
    width:100%; padding:9px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
  }
  input.invalid{border-color:var(--danger)}
  textarea{min-height:160px; resize:vertical}
  .muted{color:var(--muted);font-size:12px}
  .help{font-size:12px; margin-top:6px; color:var(--muted)}
  .help.error{color:var(--danger)}
  .ok{color:var(--ok);font-weight:700}
  .err{color:var(--danger)}
  .list{width:100%; border-collapse:collapse; background:#fff; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden}
  .list th, .list td{padding:4px 8px; border-bottom:1px solid #eef2f7}
  .list tr{height:var(--row-h)}
  .list th{background:#f1f5f9;text-align:left;font-size:14px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#eef6fb;border:1px solid #cfe3ee;color:#083344;padding:4px 10px;border-radius:999px;margin:4px 6px 0 0}
  .x{font-weight:900;cursor:pointer}
  .section-title{margin:10px 0 6px;font-size:18px;border-top:3px solid #5b9bd5;padding-top:10px}
  .space{height:6px}
  .hide{display:none}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .panel{background:#fff;width:min(680px,96vw);border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal .head{padding:12px 16px;border-bottom:1px solid #eef2f7;font-weight:700}
  .modal .body{padding:16px}
  .modal .foot{padding:14px 16px;border-top:1px solid #eef2f7;display:flex;gap:10px;justify-content:flex-end}
</style>
</head>
<body>
<div class="shell">
  <div class="bar">
    <div class="center-actions">
      <!-- Back is hidden on Screen-1, shown on Screen-2/3 -->
      <button class="btn" id="btnBack">← Back</button>
      <button class="btn" id="btnClose">Close</button>
    </div>
    <div class="bar-right">
      <strong>Request Actual Access</strong>
      <button class="btn" id="btnTopNext" disabled>Next</button>
    </div>
  </div>

  <!-- ========== STEP 1 (unchanged) ========== -->
  <section class="card" id="step1">
    <div class="hdr"><h1>Pre-Requisites</h1></div>
    <div class="muted">Ensuring privacy … (static copy for POC)</div>
    <div class="space"></div>
    <div class="row">
      <div style="flex:0 0 180px;"><label class="req">Agreement</label></div>
      <div><span id="agreementState" class="err">Agreement is not signed.</span></div>
      <div style="flex:0 0 200px;text-align:right">
        <button class="btn" id="markAgreement">Mark completed</button>
      </div>
    </div>
    <div class="row">
      <div style="flex:0 0 180px;"><label class="req">Training</label></div>
      <div><span id="trainingState" class="err">Training is not completed</span></div>
      <div style="flex:0 0 200px;text-align:right">
        <button class="btn" id="markTraining">Mark completed</button>
      </div>
    </div>
  </section>

  <!-- ========== STEP 2 (unchanged visuals from your last working) ========== -->
  <section class="card" id="step2" style="display:none">
    <div class="hdr"><h1>Access Details</h1></div>

    <div class="row">
      <div>
        <label class="req">Enter user name</label>
        <input type="text" id="searchBox" placeholder="Search" />
      </div>
      <div style="flex:0 0 120px;align-self:flex-end;text-align:right">
        <button class="btn" id="btnClear">Clear</button>
      </div>
    </div>

    <div>
      <div class="muted">Selected users</div>
      <div id="chips"></div>
    </div>

    <div class="section-title">Access Duration</div>
    <div class="row" style="align-items:flex-start">
      <div style="max-width:320px">
        <label class="req">Enter Duration</label>
        <input type="date" id="dt" />
        <div id="dtHelp" class="help">
          The date can not be today, before today or later than the current fiscal year (Fiscal year is – July 25 to Jun 26).
        </div>
      </div>
      <div style="flex:1"></div>
    </div>

    <div class="space"></div>
    <table class="list" id="tbl">
      <thead><tr><th style="width:40%">Alias</th><th style="width:40%">Display name</th><th style="width:20%"></th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <!-- ========== STEP 3 (fixed alignment) ========== -->
  <section class="card" id="step3" style="display:none">
    <div class="hdr"><h1>Title & Business Justification</h1></div>

    <div class="grid-2">
      <!-- Row 1 -->
      <div>
        <label>Current title</label>
        <div class="pill" title="from HR system">Soft-Architect-Service</div>
      </div>
      <div>
        <label>Your new title</label>
        <select id="newTitle">
          <option>Architect</option>
          <option selected>Senior Architect</option>
          <option>Principal Engineer</option>
          <option>Staff Engineer</option>
        </select>
      </div>

      <!-- Row 2: textarea spans both columns so its RIGHT EDGE matches the dropdown -->
      <div style="grid-column:1 / 3">
        <label class="req">Business Justification</label>
        <textarea id="bz"></textarea>
        <div id="bzErr" class="err" style="display:none">Business justification is required.</div>
      </div>

      <!-- Row 3: Submit on new row, right aligned -->
      <div style="grid-column:1 / 3; text-align:right; margin-top:4px">
        <button class="btn" id="btnSubmit">Submit</button>
      </div>
    </div>
  </section>
</div>

<!-- CONFIRMATION -->
<div class="modal" id="confirm">
  <div class="panel">
    <div class="head">Confirm selection</div>
    <div class="body"><div id="confirmText"></div></div>
    <div class="foot">
      <button class="btn" id="cCancel">Cancel</button>
      <button class="btn" id="cOK">OK</button>
    </div>
  </div>
</div>

<!-- FEEDBACK (textarea right-aligned with OK) -->
<div class="modal" id="feedback">
  <div class="panel">
    <div class="head">Feedback</div>
    <div class="body">
      <div class="muted" style="margin-bottom:8px">Optional: share quick feedback about this flow.</div>
      <textarea id="fb" style="min-height:110px;width:100%"></textarea>
    </div>
    <div class="foot">
      <button class="btn" id="fbCancel">Cancel</button>
      <button class="btn" id="fbOK">OK</button>
    </div>
  </div>
</div>

<script>
/* ===== STATIC DATA (POC) ===== */
const allUsers = [
  { alias:"akanoo", displayName:"A. Kanoo" },
  { alias:"alexr",  displayName:"Alex Ritchie" },
  { alias:"chenl",  displayName:"Lena Chen" },
  { alias:"dev_1",  displayName:"Devendra Prasad" },
  { alias:"isham",  displayName:"Isham Malik" },
  { alias:"jdoe",   displayName:"John Doe" },
  { alias:"katew",  displayName:"Kate Williams" },
  { alias:"liamj",  displayName:"Liam Johnson" },
  { alias:"mshah",  displayName:"Mira Shah" },
  { alias:"ninad",  displayName:"Ninad Kulkarni" },
  { alias:"olgap",  displayName:"Olga Petrova" },
  { alias:"omarh",  displayName:"Omar Hassan" },
  { alias:"pk",     displayName:"Priya Kapoor" },
  { alias:"ravin",  displayName:"Ravi Nair" },
  { alias:"sarab",  displayName:"Sara Bhandari" },
  { alias:"timq",   displayName:"Tim Quinn" },
  { alias:"vikz",   displayName:"Vikram Zaveri" },
  { alias:"zedx",   displayName:"Zed Xu" }
].sort((a,b)=>a.alias.localeCompare(b.alias));

/* ===== DOM ===== */
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');

const btnBack = document.getElementById('btnBack');
const btnClose = document.getElementById('btnClose');
const btnTopNext = document.getElementById('btnTopNext');

const markAgreement = document.getElementById('markAgreement');
const markTraining = document.getElementById('markTraining');
const agreementState = document.getElementById('agreementState');
const trainingState  = document.getElementById('trainingState');

const rows = document.getElementById('rows');
const chips = document.getElementById('chips');
const searchBox = document.getElementById('searchBox');
const btnClear = document.getElementById('btnClear');
const dt = document.getElementById('dt');
const dtHelp = document.getElementById('dtHelp');

const newTitle = document.getElementById('newTitle');
const bz = document.getElementById('bz');
const bzErr = document.getElementById('bzErr');
const btnSubmit = document.getElementById('btnSubmit');

const confirm = document.getElementById('confirm');
const confirmText = document.getElementById('confirmText');
const cCancel = document.getElementById('cCancel');
const cOK = document.getElementById('cOK');

const feedback = document.getElementById('feedback');
const fb = document.getElementById('fb');
const fbCancel = document.getElementById('fbCancel');
const fbOK = document.getElementById('fbOK');

/* ===== NAV ===== */
let current = 1;
function show(step){
  step1.style.display = step===1?'block':'none';
  step2.style.display = step===2?'block':'none';
  step3.style.display = step===3?'block':'none';
  current = step;
  btnBack.classList.toggle('hide', current===1); // hide on first screen
  refreshTopNext();
}
btnBack.onclick  = ()=> show(current>1 ? current-1 : 1); // from 3 -> 2
btnClose.onclick = ()=> notifyParentClose();
function notifyParentClose(payload){
  try{ window.parent.postMessage({ type:"tm.close", payload }, "*"); }catch(e){}
}

/* ===== SCREEN 1 state ===== */
let prAgreement = false;
let prTraining  = false;
function evalStep1(){
  if(prAgreement){ agreementState.textContent = 'Agreement signed.'; agreementState.classList.remove('err'); agreementState.classList.add('ok'); markAgreement.disabled = true; }
  else{ agreementState.textContent = 'Agreement is not signed.'; agreementState.classList.remove('ok'); agreementState.classList.add('err'); markAgreement.disabled = false; }
  if(prTraining){ trainingState.textContent = 'Training completed'; trainingState.classList.remove('err'); trainingState.classList.add('ok'); markTraining.disabled = true; }
  else{ trainingState.textContent = 'Training is not completed'; trainingState.classList.remove('ok'); trainingState.classList.add('err'); markTraining.disabled = false; }
  refreshTopNext();
}
markAgreement.onclick = ()=>{ prAgreement = true; evalStep1(); };
markTraining .onclick = ()=>{ prTraining  = true; evalStep1(); };
evalStep1();

/* ===== IST + FY ===== */
function todayISTYMD(){
  return new Intl.DateTimeFormat('en-CA',{ timeZone:'Asia/Kolkata', year:'numeric', month:'2-digit', day:'2-digit' }).format(new Date());
}
function fyWindowStrings(todayStr){
  const [Y,M,D] = todayStr.split('-').map(Number);
  const inSecondHalf = (M>7) || (M===7 && D>=25);
  const y = Y;
  return inSecondHalf ? { start:`${y}-07-25`, end:`${y+1}-06-26` }
                      : { start:`${y-1}-07-25`, end:`${y}-06-26` };
}

/* ===== SCREEN 2 ===== */
let selected = new Set();

function validateDuration(){
  const chosen = dt.value;
  const today  = todayISTYMD();
  const {start,end} = fyWindowStrings(today);
  let ok = false;
  if(chosen){
    const isAfterToday = chosen > today;
    const inFY = (chosen >= start && chosen <= end);
    ok = isAfterToday && inFY;
  }
  dt.classList.toggle('invalid', !ok);
  dtHelp.classList.toggle('error', !ok);
  return ok;
}
function step1Ready(){ return prAgreement && prTraining; }
function step2Ready(){ return selected.size>0 && validateDuration(); }
function refreshTopNext(){
  if(current===1)      btnTopNext.disabled = !step1Ready();
  else if(current===2) btnTopNext.disabled = !step2Ready();
  else                 btnTopNext.disabled = true;
}
(function presetDateToToday(){
  dt.value = todayISTYMD();
  validateDuration();
  refreshTopNext();
})();
dt.addEventListener('change', ()=>{ validateDuration(); refreshTopNext(); });

function renderRows(){
  const q = searchBox.value.trim().toLowerCase();
  const frag = document.createDocumentFragment();
  allUsers.forEach(u=>{
    const dispName = u.displayName || u.name || '';
    if(q && !(u.alias.toLowerCase().includes(q) || dispName.toLowerCase().includes(q))) return;
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = u.alias;
    const td2 = document.createElement('td'); td2.textContent = dispName;
    const td3 = document.createElement('td'); td3.style.textAlign='right';
    const b = document.createElement('button');
    b.className='btn'; b.textContent = selected.has(u.alias)?'Added':'Add';
    b.disabled = selected.has(u.alias);
    b.onclick = ()=>{ selected.add(u.alias); renderChips(); renderRows(); refreshTopNext(); };
    td3.appendChild(b);
    tr.append(td1,td2,td3);
    frag.appendChild(tr);
  });
  rows.replaceChildren(frag);
}
function renderChips(){
  const frag = document.createDocumentFragment();
  Array.from(selected).sort().forEach(a=>{
    const pill = document.createElement('span'); pill.className='pill';
    pill.innerHTML = `<span>${a}</span><span class="x" title="Remove">&times;</span>`;
    pill.querySelector('.x').onclick = ()=>{ selected.delete(a); renderChips(); renderRows(); refreshTopNext(); };
    frag.appendChild(pill);
  });
  chips.replaceChildren(frag);
}
renderRows();
searchBox.addEventListener('input', renderRows);
btnClear.onclick = ()=>{ searchBox.value=''; selected.clear(); renderChips(); renderRows(); refreshTopNext(); };

/* NEXT across steps */
btnTopNext.onclick = ()=>{
  if(current===1 && step1Ready()){
    show(2);
    return;
  }
  if(current===2 && step2Ready()){
    const when = dt.value.split('-').reverse().join('/'); // dd/mm/yyyy
    const list = Array.from(selected).sort().map(a=>`<li>${a}</li>`).join('');
    confirmText.innerHTML = `<div>Following users are selected for <strong>${when}</strong>:</div><ul>${list}</ul>`;
    confirm.style.display='flex';
  }
};

/* CONFIRM → STEP 3 */
cCancel.onclick = ()=> confirm.style.display='none';
cOK.onclick = ()=>{ confirm.style.display='none'; show(3); };

/* ===== STEP 3 ===== */
function validateBZ(){ const ok = bz.value.trim().length>0; bzErr.style.display = ok?'none':'block'; return ok; }
bz.addEventListener('input', validateBZ);

btnSubmit.onclick = ()=>{
  if(!validateBZ()) return;

  /* ----- PUSH: create request (Power Automate / API) -----
     const payload = {
       date: dt.value,
       users: Array.from(selected),
       newTitle: newTitle.value,
       justification: bz.value.trim()
     };
     fetch('<<YOUR_API_URL>>', {
       method:'POST',
       headers:{'content-type':'application/json'},
       body: JSON.stringify(payload)
     })
     .then(r => r.ok ? r.json() : Promise.reject(r))
     .then(resp => notifyParentClose({result:'ok', summary: payload, server: resp}))
     .catch(() => alert('Failed to submit request'));
  --------------------------------------------------------- */

  // POC: show compact feedback; on OK close TM.
  feedback.style.display='flex';
};

/* FEEDBACK (right-aligned) */
fbCancel.onclick = ()=>{ feedback.style.display='none'; notifyParentClose({result:'ok'}); };
fbOK.onclick = ()=>{ feedback.style.display='none'; notifyParentClose({result:'ok', feedback: fb.value}); };
</script>
</body>
</html>

