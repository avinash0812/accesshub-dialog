<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Request Actual Access — Search</title>
<style>
  :root{
    --bg:#f6f8fb;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;
    --accent:#0b5d7a;--accent-2:#0e6f96;--ok:#1f9d55;--chip:#eef6fb;
    --line:#e5e7eb;--danger:#b00020;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  h1{font-size:18px;margin:0 0 12px}
  .wrap{max-width:1100px;margin:18px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .toolbar{display:grid;grid-template-columns:240px 120px 1fr 96px;gap:6px;align-items:end}
  label{display:block;font-weight:600;margin-bottom:4px}
  select,input[type="text"],input[type="date"]{
    width:100%;height:36px;border:1px solid var(--line);border-radius:8px;padding:0 10px;outline:none;background:#fff
  }
  select:focus,input:focus{border-color:var(--accent)}
  .btn{height:36px;border-radius:10px;border:0;padding:0 14px;color:#fff;background:var(--accent);cursor:pointer}
  .btn:hover{background:var(--accent-2)}
  .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
  .btn.ok{background:var(--ok)}
  .btn.danger{background:var(--danger)}
  .sep{height:1px;background:var(--line);margin:8px 0}
  .section h3{margin:10px 0 4px;font-size:15px}
  .underline{height:4px;background:var(--accent);border-radius:2px;width:220px;margin:-2px 0 6px}
  .muted{color:var(--muted);font-size:11.5px}

  /* Selected chips */
  .chips{display:flex;gap:6px;flex-wrap:wrap;min-height:36px;padding:6px;border:1px dashed var(--line);border-radius:10px;background:#fff}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #dbe9f3;border-radius:999px;padding:2px 8px;font-size:11.5px}
  .chip button{border:0;background:transparent;cursor:pointer;color:var(--muted);font-size:14px;line-height:1}
  .chip button:hover{color:#000}

  /* Table */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0 2px;margin-top:6px}
  thead th{position:sticky;top:0;background:#f1f5f9;color:#334155;padding:6px 10px;text-align:left;font-size:11.5px}
  tbody td{padding:6px 10px;background:#fff;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  tbody tr{transition:background .12s;border-radius:10px}
  tbody tr:hover{background:#f7fbfe}
  .row-actions{display:flex;gap:6px;align-items:center}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:11px}

  .footer{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin-top:6px}

  /* Modal */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:12px}
  .modal{background:#fff;border-radius:12px;max-width:520px;width:100%;padding:14px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .modal h4{margin:0 0 6px}
  .modal .list{padding-left:18px;margin:4px 0 10px}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px}
  .center-note{font-size:12px;color:var(--muted);margin-top:6px}

  /* ===== Compact overrides for tight vertical rhythm ===== */
  .wrap{ padding:16px; }
  .card{ padding:14px; }
  .toolbar{ gap:6px; grid-template-columns:240px 120px 1fr 96px; }
  label{ margin-bottom:4px; }
  select, input[type="text"], input[type="date"]{ height:36px; }
  .sep{ margin:8px 0; }
  .section h3{ margin:10px 0 4px; font-size:15px; }
  .underline{ height:4px; margin:-2px 0 6px; width:220px; }
  .chips{ padding:6px; min-height:36px; }
  .chip{ padding:2px 8px; font-size:11.5px; }
  table{ border-spacing:0 2px; margin-top:6px; }
  thead th{ padding:6px 10px; }
  tbody td{ padding:6px 10px; }
  .btn{ height:36px; padding:0 12px; }
  .footer{ margin-top:6px; }
  .muted{ font-size:11.5px; }
  .modal{ padding:14px; }
  @media (max-height: 800px){
    .card{padding:12px}
    select,input[type="text"],input[type="date"],.btn{height:34px}
    tbody td{padding:5px 8px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Request Actual Access — Search</h1>

    <div class="card">
      <!-- Search toolbar -->
      <div class="toolbar">
        <div>
          <label for="loginUser">Login User</label>
          <select id="loginUser"></select>
        </div>

        <div>
          <label for="showN">Show</label>
          <select id="showN">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="All">All</option>
          </select>
        </div>

        <div>
          <label for="q">Search alias or name</label>
          <input id="q" type="text" placeholder="Type alias or name and click Search" />
        </div>

        <div>
          <button class="btn" id="btnSearch">Search</button>
        </div>
      </div>

      <div class="sep"></div>

      <!-- Selected users -->
      <div class="section">
        <h3>Selected Users</h3>
        <div class="underline"></div>
        <div id="chips" class="chips" aria-live="polite"></div>
      </div>

      <div class="sep"></div>

      <!-- Results table -->
      <div class="section">
        <h3>Results</h3>
        <div class="underline"></div>
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:36px">Add</th>
                <th>Alias</th>
                <th>Name</th>
                <th style="width:140px">Login User</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="muted" id="countNote">0 results</div>
      </div>

      <div class="sep"></div>

      <!-- Access duration -->
      <div class="section">
        <h3>Access Duration</h3>
        <div class="underline"></div>
        <div style="max-width:280px">
          <label for="when">Enter Duration <span class="muted">*</span></label>
          <input type="date" id="when" />
          <div class="muted">The date cannot be today, before today or later than the current fiscal year (July 25 – Jun 26).</div>
        </div>
      </div>

      <div class="footer">
        <button class="btn ghost" id="btnClear">Clear</button>
        <button class="btn" id="btnNext">Next</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <h4 id="confirmTitle">Confirm selection</h4>
      <div id="confirmBody" class="muted"></div>
      <ul id="confirmList" class="list"></ul>
      <div class="actions">
        <button class="btn ghost" id="mClose">Close</button>
        <button class="btn ok" id="mConfirm">Submit</button>
      </div>
      <div class="center-note">This dialog is centered over the task module and returns data back to Copilot Studio.</div>
    </div>
  </div>

<script>
/* ============== Static demo data ============== */
const DATA = [
  { loginuser:"User1", alias:"akanoo", name:"Ashish Kanoongo" },
  { loginuser:"User1", alias:"jdoe",   name:"John Doe" },
  { loginuser:"User1", alias:"mshah",  name:"Meera Shah" },
  { loginuser:"User1", alias:"sgeorge",name:"Sam George" },
  { loginuser:"User1", alias:"pk",     name:"Priya K" },
  { loginuser:"User1", alias:"alexr",  name:"Alex R" },
  { loginuser:"User1", alias:"chenl",  name:"Chen Li" },

  { loginuser:"User2", alias:"katew",  name:"Kate W" },
  { loginuser:"User2", alias:"omarh",  name:"Omar H" },
  { loginuser:"User2", alias:"sarab",  name:"Sara B" },
  { loginuser:"User2", alias:"timq",   name:"Tim Q" },
  { loginuser:"User2", alias:"ninad",  name:"Nina D" },
  { loginuser:"User2", alias:"vikz",   name:"Vik Z" },

  { loginuser:"User3", alias:"liamj",  name:"Liam J" },
  { loginuser:"User3", alias:"isham",  name:"Isha M" },
  { loginuser:"User3", alias:"ravin",  name:"Ravi N" },
  { loginuser:"User3", alias:"olgap",  name:"Olga P" },

  { loginuser:"User4", alias:"zedx",   name:"Zed X" },
  { loginuser:"User4", alias:"riak",   name:"Riak" },
  { loginuser:"User4", alias:"dev_1",  name:"Dev One" },
];

/* Merge User1 + User3 as requested for the view */
const MERGE_USER13 = true; // toggle if needed
let viewData = [...DATA];
if (MERGE_USER13){
  viewData = DATA.map(r => r.loginuser === "User3" ? ({...r, loginuser:"User1"}) : r);
}

/* ============== Elements ============== */
const loginSel = document.getElementById('loginUser');
const showSel  = document.getElementById('showN');
const qInp     = document.getElementById('q');
const tblBody  = document.getElementById('rows');
const countEl  = document.getElementById('countNote');
const chipsEl  = document.getElementById('chips');
const whenInp  = document.getElementById('when');

const btnSearch= document.getElementById('btnSearch');
const btnClear = document.getElementById('btnClear');
const btnNext  = document.getElementById('btnNext');

const backdrop = document.getElementById('backdrop');
const mClose   = document.getElementById('mClose');
const mConfirm = document.getElementById('mConfirm');
const confirmBody = document.getElementById('confirmBody');
const confirmList = document.getElementById('confirmList');

/* ============== State ============== */
const selected = new Map(); // alias -> record

/* ============== Helpers ============== */
const byAlias = (a,b)=> a.alias.localeCompare(b.alias, undefined, {sensitivity:'base'});
function uniq(arr, key){ const seen=new Set(); return arr.filter(x=>!seen.has(x[key]) && seen.add(x[key])); }
function readParams(){
  const u = new URLSearchParams(location.search);
  return {
    loginuser: u.get('loginuser') || 'All',
    show:      u.get('show') || '20',
    q:         u.get('q') || ''
  };
}
function fillLoginOptions(){
  const users = uniq(viewData.map(r=>({loginuser:r.loginuser})), 'loginuser').map(x=>x.loginuser).sort();
  loginSel.innerHTML = `<option value="All">All</option>` + users.map(u=>`<option value="${u}">${u}</option>`).join('');
}
function renderChips(){
  chipsEl.innerHTML = '';
  if (selected.size === 0){
    chipsEl.innerHTML = `<span class="muted">No users selected.</span>`;
    return;
  }
  [...selected.values()].sort(byAlias).forEach(r=>{
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `<span>${r.alias}</span><button title="Remove" aria-label="Remove ${r.alias}">×</button>`;
    chip.querySelector('button').onclick = ()=>{ selected.delete(r.alias); renderChips(); };
    chipsEl.appendChild(chip);
  });
}
function filterData(){
  const who = loginSel.value;
  const q = qInp.value.trim().toLowerCase();
  let rows = viewData;
  if (who !== 'All') rows = rows.filter(r=>r.loginuser === who);
  if (q){
    rows = rows.filter(r => r.alias.toLowerCase().includes(q) || r.name.toLowerCase().includes(q));
  }
  rows.sort(byAlias);
  const n = showSel.value === 'All' ? rows.length : Number(showSel.value||0);
  return rows.slice(0, n);
}
function renderTable(){
  const rows = filterData();
  countEl.textContent = `${rows.length} result${rows.length!==1?'s':''}`;
  tblBody.innerHTML = rows.map(r=>`
    <tr>
      <td>
        <button class="btn" style="height:28px;padding:0 8px" data-add="${r.alias}">Add</button>
      </td>
      <td><span class="pill">${r.alias}</span></td>
      <td>${r.name}</td>
      <td>${r.loginuser}</td>
    </tr>
  `).join('');
  // Attach handlers
  tblBody.querySelectorAll('[data-add]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const alias = e.currentTarget.getAttribute('data-add');
      const rec = filterData().find(x=>x.alias===alias) || viewData.find(x=>x.alias===alias);
      if (rec){ selected.set(alias, rec); renderChips(); }
    });
  });
}

/* ============== Validation ============== */
function validDate(dStr){
  if (!dStr) return false;
  const d = new Date(dStr);
  const today = new Date(); today.setHours(0,0,0,0);
  if (d <= today) return false;
  // crude fiscal guard July 25 to next Jun 26 (demo only)
  const fyStart = new Date(today.getFullYear(), 6, 25); // Jul 25
  const fyEnd   = new Date(today.getFullYear()+1, 5, 26); // Jun 26 next year
  return (d >= fyStart && d <= fyEnd);
}

/* ============== Modal ============== */
function openModal(){
  const when = whenInp.value;
  const list = [...selected.values()].sort(byAlias);
  confirmBody.innerHTML = list.length === 0
    ? `No users selected.`
    : `You’re about to request access for <strong>${list.length}</strong> user(s) on <strong>${formatDate(when)}</strong>:`;
  confirmList.innerHTML = list.map(r=>`<li><code>${r.alias}</code> — ${r.name}</li>`).join('');
  backdrop.style.display = 'flex';
}
function closeModal(){ backdrop.style.display = 'none'; }
function formatDate(iso){
  if (!iso) return '(no date)';
  const d = new Date(iso);
  return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
}

/* ============== Wire up ============== */
fillLoginOptions();
const p = readParams();
loginSel.value = [...Array.from(loginSel.options)].some(o=>o.value===p.loginuser) ? p.loginuser : 'All';
showSel.value  = p.show;
qInp.value     = p.q;

renderTable(); renderChips();

btnSearch.addEventListener('click', renderTable);
showSel.addEventListener('change', renderTable);
loginSel.addEventListener('change', renderTable);
qInp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); renderTable(); } });

btnClear.addEventListener('click', ()=>{
  qInp.value=''; selected.clear(); renderChips(); renderTable();
});

btnNext.addEventListener('click', ()=>{
  if (selected.size === 0){ alert('Please select at least one user.'); return; }
  if (!validDate(whenInp.value)){ alert('Please pick a valid date (after today and within this fiscal year).'); return; }
  openModal();
});

mClose.addEventListener('click', closeModal);
backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeModal(); });

mConfirm.addEventListener('click', ()=>{
  // In production, postMessage this payload to the parent task module or return via Teams SDK.
  const payload = {
    action: 'tmSearchSubmit',
    when: whenInp.value,
    users: [...selected.values()].map(({loginuser,alias,name})=>({loginuser,alias,name}))
  };
  console.log('Submit payload:', payload);
  alert('Submitted!\n\n' + JSON.stringify(payload,null,2));
  closeModal();
});
</script>
</body>
</html>
